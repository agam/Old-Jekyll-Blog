
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Agam's Mashed-Up Pome</title>
  <meta name="author" content="Agam">

   
  <meta name="description" content="">
  
  <meta name="keywords" content="">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://agam.github.io/blog/page/4">
  <link href="/favicon.png" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Quicksand:300,400' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Agam's Mashed-Up Pome" type="application/atom+xml">
  <script src="/js/jquery.js"></script>
  <script src="/js/bootstrap-collapse.js"></script>
  <script src="/js/modernizr-2.0.js"></script>
  <script src="/js/octopress.js" type="text/javascript"></script>
  <script src="/js/application.js"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-16612682-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <div class="navbar navbar-inverse navbar-static-top">
  	<div class="navbar-inner">
  	  <div class="container">
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".navbar-responsive-collapse">
          <span class="fui-menu-24"></span>
        </a>
  	  	<div class="nav-collapse collapse navbar-responsive-collapse" style="height:0;">
  	      <ul class="nav">
    
</ul>

<ul class="nav pull-right">
    
    
    
    <li><a href="http://twitter.com/agambrahma" title="Twitter Profile"><i class="icon-twitter-sign social-navbar"></i></a></li>
    
    
    <li><a href="http://plus.google.com/+AgamBrahma" title="Google+ Profile"><i class="icon-google-plus-sign social-navbar"></i></a></li>
    
    
    
</ul>

  	    </div>
  	  </div>
  	</div>
  </div>
  <div class="container" id="main">
      <div class="row-fluid">
        <div id="content">
          <div class="jumbotron">
  <div class="container">
    Agam&#8217;s Mashed-Up Pome
    <h3 class="tagline">Thinking is hard; Let&#8217;s compute instead.</h3>
  </div>
</div>


<div class="blog-index">
  
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2013-09-30T00:00:00+00:00" pubdate data-updated="true">Sep 30<span>th</span>, 2013</time></h5>
          <div class="row-fluid">
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/boost/"><span class="badge">Boost</span></a>
          
          <a href="/blog/categories/clang/"><span class="badge">Clang</span></a>
          
          <a href="/blog/categories/gcc/"><span class="badge">Gcc</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2013/09/30/less-gcc-more-clang/">Less Gcc, More Clang</a></h1>
      <p>I was unhappy with how I had not fully figured out my <code>libstdc++ &lt;-&gt; gcc/clang &lt;-&gt; boost</code> issues, and was feeling a bit ashamed that I had let the complexity of the system beat me.</p>

<p><em>First, burn your boats</em></p>

<p>The first thing I decided to do was get rid of the newly installed <code>gcc 4.7</code> and commit to getting a working version, recompiling/downloading/installing whatever it took.</p>

<p>The second was to recompile Boost with Clang.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/usr/clang_3_3/bin:<span class="nv">$PATH</span>
</span><span class='line'>./bootstrap.sh --with-toolset<span class="o">=</span>clang
</span><span class='line'>./b2 install --prefix<span class="o">=</span>/opt/boost/boost_1_54_0
</span><span class='line'><span class="nb">echo </span><span class="nv">PATH</span><span class="o">=</span>/opt/boost/boost_1_54_0/bin:<span class="nv">$PATH</span>
</span><span class='line'>./b2 --build-dir<span class="o">=</span>/tmp/build-boost <span class="nv">toolset</span><span class="o">=</span>clang stage
</span></code></pre></td></tr></table></div></figure>


<p>This took a while to run, but in the end, I got</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>...failed updating 4 targets...
</span><span class='line'>...skipped 6 targets...
</span><span class='line'>...updated 1073 targets...
</span></code></pre></td></tr></table></div></figure>


<p>Wha &hellip; 4 failed ? Scrolling up, I see for example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>clang: /home/agam/Documents/Code/Building/Clang/llvm/lib/IR/Instructions.cpp:2929: llvm::BitCastInst::BitCastInst<span class="o">(</span>llvm::Value*, llvm::Type*, const llvm::Twine&amp;, llvm::Instruction*<span class="o">)</span>: Assertion <span class="sb">`</span>castIsValid<span class="o">(</span>getOpcode<span class="o">()</span>, S, Ty<span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;Illegal BitCast&quot;</span><span class="s1">&#39; failed.</span>
</span><span class='line'><span class="s1">0  clang           0x0000000002569c72 llvm::sys::PrintStackTrace(_IO_FILE*) + 34</span>
</span><span class='line'><span class="s1">1  clang           0x0000000002569059</span>
</span><span class='line'><span class="s1">2  libpthread.so.0 0x00007f13948eecb0</span>
</span><span class='line'><span class="s1">3  libc.so.6       0x00007f1393919425 gsignal + 53</span>
</span><span class='line'><span class="s1">4  libc.so.6       0x00007f139391cb8b abort + 379</span>
</span><span class='line'><span class="s1">5  libc.so.6       0x00007f13939120ee</span>
</span><span class='line'><span class="s1">6  libc.so.6       0x00007f1393912192</span>
</span><span class='line'><span class="s1">7  clang           0x00000000024de388</span>
</span><span class='line'><span class="s1">8  clang           0x0000000002192568</span>
</span><span class='line'><span class="s1">9  clang           0x00000000021928ae</span>
</span><span class='line'><span class="s1">10 clang           0x000000000215748e</span>
</span><span class='line'><span class="s1">11 clang           0x00000000021584a0</span>
</span><span class='line'><span class="s1">12 clang           0x00000000024fa4cf llvm::FPPassManager::runOnFunction(llvm::Function&amp;) + 607</span>
</span><span class='line'><span class="s1">13 clang           0x000000000224ac48</span>
</span><span class='line'><span class="s1">14 clang           0x000000000224e7b9</span>
</span><span class='line'><span class="s1">15 clang           0x00000000024f9fd0 llvm::MPPassManager::runOnModule(llvm::Module&amp;) + 688</span>
</span><span class='line'><span class="s1">16 clang           0x00000000024fa1a5 llvm::PassManagerImpl::run(llvm::Module&amp;) + 245</span>
</span><span class='line'><span class="s1">17 clang           0x0000000000903e8e clang::EmitBackendOutput(clang::DiagnosticsEngine&amp;, clang::CodeGenOptions const&amp;, clang::TargetOptions const&amp;, clang::LangOptions const&amp;, llvm::Module*, clang::BackendAction, llvm::raw_ostream*) + 3550</span>
</span><span class='line'><span class="s1">18 clang           0x00000000009013bd</span>
</span><span class='line'><span class="s1">19 clang           0x0000000000aa8c24 clang::ParseAST(clang::Sema&amp;, bool, bool) + 372</span>
</span><span class='line'><span class="s1">20 clang           0x000000000077bafa clang::FrontendAction::Execute() + 282</span>
</span><span class='line'><span class="s1">21 clang           0x000000000075eca0 clang::CompilerInstance::ExecuteAction(clang::FrontendAction&amp;) + 352</span>
</span><span class='line'><span class="s1">22 clang           0x0000000000744a8a clang::ExecuteCompilerInvocation(clang::CompilerInstance*) + 1722 23 clang           0x000000000073ddf0 cc1_main(char const**, char const**, char const*, void*) + 1232</span>
</span><span class='line'><span class="s1">24 clang           0x000000000072190e main + 622</span>
</span><span class='line'><span class="s1">25 libc.so.6       0x00007f139390476d __libc_start_main + 237</span>
</span><span class='line'><span class="s1">26 clang           0x000000000073d7ad</span>
</span><span class='line'><span class="s1">Stack dump:</span>
</span><span class='line'><span class="s1">0.      Program arguments: /usr/clang_3_3/bin/clang -cc1 -triple</span>
</span><span class='line'><span class="s1">x86_64-unknown-linux-gnu -emit-obj -disable-free -main-file-name</span>
</span><span class='line'><span class="s1">settings_parser.cpp -mrelocation-model pic -pic-level 2 -fmath-errno</span>
</span><span class='line'><span class="s1">-masm-verbose -mconstructor-aliases -munwind-tables -target-cpu x86-64</span>
</span><span class='line'><span class="s1">-target-linker-version 2.22 -momit-leaf-frame-pointer -coverage-file</span>
</span><span class='line'><span class="s1">/tmp/build-boost/boost/bin.v2/libs/log/build/clang-linux-3.4/release/log-api-</span>
</span><span class='line'><span class="s1">unix/threading-multi/settings_parser.o -resource-dir</span>
</span><span class='line'><span class="s1">/usr/clang_3_3/bin/../lib/clang/3.4 -D BOOST_ALL_NO_LIB=1 -D</span>
</span><span class='line'><span class="s1">BOOST_CHRONO_DYN_LINK=1 -D BOOST_DATE_TIME_DYN_LINK=1 -D</span>
</span><span class='line'><span class="s1">BOOST_FILESYSTEM_DYN_LINK=1 -D BOOST_LOG_DYN_LINK=1 -D</span>
</span><span class='line'><span class="s1">BOOST_LOG_SETUP_BUILDING_THE_LIB=1 -D BOOST_LOG_SETUP_DLL -D BOOST_LOG_USE_AVX2</span>
</span><span class='line'><span class="s1">-D BOOST_LOG_USE_NATIVE_SYSLOG -D BOOST_LOG_USE_SSSE3 -D</span>
</span><span class='line'><span class="s1">BOOST_LOG_WITHOUT_EVENT_LOG -D BOOST_SPIRIT_USE_PHOENIX_V3=1 -D</span>
</span><span class='line'><span class="s1">BOOST_SYSTEM_DYN_LINK=1 -D BOOST_SYSTEM_NO_DEPRECATED -D</span>
</span><span class='line'><span class="s1">BOOST_THREAD_BUILD_DLL=1 -D BOOST_THREAD_DONT_USE_CHRONO=1 -D BOOST_THREAD_POSIX</span>
</span><span class='line'><span class="s1">-D BOOST_THREAD_USE_DLL=1 -D DATE_TIME_INLINE -D NDEBUG -I . -internal-isystem</span>
</span><span class='line'><span class="s1">/usr/lib/gcc/x86_64-linux-gnu/4.6/../../../../include/c++/4.6 -internal-isystem</span>
</span><span class='line'><span class="s1">/usr/lib/gcc/x86_64-linux-gnu/4.6/../../../../include/c++/4.6/x86_64-linux-gnu</span>
</span><span class='line'><span class="s1">-internal-isystem</span>
</span><span class='line'><span class="s1">/usr/lib/gcc/x86_64-linux-gnu/4.6/../../../../include/c++/4.6/backward</span>
</span><span class='line'><span class="s1">-internal-isystem</span>
</span><span class='line'><span class="s1">/usr/lib/gcc/x86_64-linux-gnu/4.6/../../../../include/x86_64-linux-gnu/c++/4.6</span>
</span><span class='line'><span class="s1">-internal-isystem /usr/local/include -internal-isystem</span>
</span><span class='line'><span class="s1">/usr/clang_3_3/bin/../lib/clang/3.4/include -internal-externc-isystem</span>
</span><span class='line'><span class="s1">/usr/include/x86_64-linux-gnu -internal-externc-isystem /include</span>
</span><span class='line'><span class="s1">-internal-externc-isystem /usr/include -O3 -Wno-bind-to-temporary-copy</span>
</span><span class='line'><span class="s1">-Wno-unused-function -Wno-inline -Wall -Wno-bind-to-temporary-copy</span>
</span><span class='line'><span class="s1">-Wno-unused-function -fdeprecated-macro -fdebug-compilation-dir</span>
</span><span class='line'><span class="s1">/opt/boost/boost_1_54_0 -ferror-limit 19 -fmessage-length 0 -pthread</span>
</span><span class='line'><span class="s1">-mstackrealign -fobjc-runtime=gcc -fobjc-default-synthesize-properties</span>
</span><span class='line'><span class="s1">-fcxx-exceptions -fexceptions -fdiagnostics-show-option -vectorize-loops</span>
</span><span class='line'><span class="s1">-vectorize-slp -o</span>
</span><span class='line'><span class="s1">/tmp/build-boost/boost/bin.v2/libs/log/build/clang-linux-3.4/release/log-api-</span>
</span><span class='line'><span class="s1">unix/threading-multi/settings_parser.o -x c++ libs/log/src/settings_parser.cpp</span>
</span><span class='line'><span class="s1">1.      &lt;eof&gt; parser at end of file</span>
</span><span class='line'><span class="s1">2.      Per-module optimization passes</span>
</span><span class='line'><span class="s1">3.      Running pass &#39;</span>CallGraph Pass Manager<span class="s1">&#39; on module &#39;</span>libs/log/src/settings_parser.cpp<span class="s1">&#39;.</span>
</span><span class='line'><span class="s1">4.      Running pass &#39;</span>Combine redundant instructions<span class="s1">&#39; on function &#39;</span>@_ZNK5boost6spirit6detail18make_binary_helperINS0_13meta_compilerINS0_2qi6domainEE12meta_grammarEE4implIRKNS_5proto7exprns_4exprINSA_6tagns_3tag10bitwise_orENSA_7argsns_5list2IRKNSC_ISF_NSH_IRNS4_4ruleIPKcNSC_INSE_8terminalENSG_4termINS0_3tag9char_codeINSN_5spaceENS0_13char_encoding8standardEEEEELl0EEENS0_11unused_typeESV_SV_EESX_EELl2EEESX_EELl2EEENS_6fusion4consINS4_10eoi_parserENS16_3nilEEERSV_EclES15_RKS1A_S1B_<span class="err">&#39;</span>
</span><span class='line'>clang: error: unable to execute <span class="nb">command</span>: Aborted <span class="o">(</span>core dumped<span class="o">)</span>
</span><span class='line'>clang: error: clang frontend <span class="nb">command </span>failed due to signal <span class="o">(</span>use -v to see invocation<span class="o">)</span>
</span><span class='line'>clang version 3.4 <span class="o">(</span>trunk 189210<span class="o">)</span>
</span><span class='line'>Target: x86_64-unknown-linux-gnu
</span><span class='line'>Thread model: posix
</span><span class='line'>clang: note: diagnostic msg: PLEASE submit a bug report to http://llvm.org/bugs/ and include the crash backtrace, preprocessed <span class="nb">source</span>, and associated run script.
</span><span class='line'>clang: note: diagnostic msg:
</span><span class='line'>********************
</span><span class='line'>
</span><span class='line'>PLEASE ATTACH THE FOLLOWING FILES TO THE BUG REPORT:
</span><span class='line'>Preprocessed <span class="nb">source</span><span class="o">(</span>s<span class="o">)</span> and associated run script<span class="o">(</span>s<span class="o">)</span> are located at:
</span><span class='line'>clang: note: diagnostic msg: /tmp/settings_parser-7f5a26.cpp
</span><span class='line'>clang: note: diagnostic msg: /tmp/settings_parser-7f5a26.sh
</span><span class='line'>clang: note: diagnostic msg:
</span><span class='line'>
</span><span class='line'>********************
</span></code></pre></td></tr></table></div></figure>


<p>Ignoring these few Boost failures for now &hellip; I do want to use Clang with <code>-stdlib=libc++</code>, so I also wanted to build <code>libcxx</code> with Clang</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">CC</span><span class="o">=</span>clang <span class="nv">CXX</span><span class="o">=</span>clang++ cmake -G <span class="s2">&quot;Unix Makefiles&quot;</span> -DLIBCXX_CXX_ABI<span class="o">=</span>libsupc++ -DLIBCXX_LIBSUPCXX_INCLUDE_PATHS<span class="o">=</span><span class="s2">&quot;/usr/include/c++/4.6/;/usr/include/c++/4.6/x86_64-linux-gnu/&quot;</span> -DCMAKE_BUILD_TYPE<span class="o">=</span>Release -DCMAKE_INSTALL_PREFIX<span class="o">=</span>/usr ../libcxx/
</span><span class='line'>make -j 4
</span><span class='line'>sudo make install
</span></code></pre></td></tr></table></div></figure>


<p>Time for our test program from earlier:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;boost/lambda/lambda.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'><span class="cp">#include &lt;algorithm&gt;</span>
</span><span class='line'><span class="cp">#include &lt;iterator&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="n">using</span> <span class="n">boost</span><span class="o">::</span><span class="n">lambda</span><span class="o">::</span><span class="n">_1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">istream_iterator</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">in</span><span class="p">;</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span>
</span><span class='line'>                <span class="n">in</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">),</span> <span class="n">in</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">_1</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, this results in a clang error:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>/usr/clang_3_3/bin/clang++ -std<span class="o">=</span>c++11 -stdlib<span class="o">=</span>libc++ -L/usr/lib -I/opt/boost/boost_1_54_0 hello-world.cpp -o hello-world -lc++abi
</span><span class='line'>/usr/bin/ld: cannot find -lc++abi
</span><span class='line'>clang: error: linker <span class="nb">command </span>failed with <span class="nb">exit </span>code 1 <span class="o">(</span>use -v to see invocation<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Wohkay, so I&rsquo;m assuming we need to build libc++abi</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>svn co http://llvm.org/svn/llvm-project/libcxxabi/trunk libcxxabi
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>libcxxabi/lib
</span><span class='line'><span class="nv">$ </span>./buildit
</span></code></pre></td></tr></table></div></figure>


<p>Now move over to the <code>libcxx</code> branch again, and</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ CC</span><span class="o">=</span>clang <span class="nv">CXX</span><span class="o">=</span>clang++ cmake -G <span class="s2">&quot;Unix Makefiles&quot;</span> -DLIBCXX_CXX_ABI<span class="o">=</span>libcxxabi -DLIBCXX_LIBCXXABI_INCLUDE_PATHS<span class="o">=</span><span class="s2">&quot;/home/agam/Documents/Code/Building/libcxxabi/include&quot;</span> -DCMAKE_BUILD_TYPE<span class="o">=</span>Release -DCMAKE_INSTALL_PREFIX<span class="o">=</span>/usr ../libcxx
</span><span class='line'>-- The CXX compiler identification is Clang 3.4.0
</span><span class='line'>-- The C compiler identification is Clang 3.4.0
</span><span class='line'>-- Check <span class="k">for </span>working CXX compiler: /usr/clang_3_3/bin/clang++
</span><span class='line'>-- Check <span class="k">for </span>working CXX compiler: /usr/clang_3_3/bin/clang++ -- works
</span><span class='line'>-- Detecting CXX compiler ABI info
</span><span class='line'>-- Detecting CXX compiler ABI info - <span class="k">done</span>
</span><span class='line'>-- Check <span class="k">for </span>working C compiler: /usr/clang_3_3/bin/clang
</span><span class='line'>-- Check <span class="k">for </span>working C compiler: /usr/clang_3_3/bin/clang -- works
</span><span class='line'>-- Detecting C compiler ABI info
</span><span class='line'>-- Detecting C compiler ABI info - <span class="k">done</span>
</span><span class='line'>-- Host triple: x86_64-pc-linux
</span><span class='line'>-- Target triple: x86_64-pc-linux
</span><span class='line'>CMake Error at CMakeLists.txt:119 <span class="o">(</span>message<span class="o">)</span>:
</span><span class='line'>  Failed to find cxa_demangle.h
</span><span class='line'>Call Stack <span class="o">(</span>most recent call first<span class="o">)</span>:
</span><span class='line'>  CMakeLists.txt:141 <span class="o">(</span>setup_abi_lib<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>-- Configuring incomplete, errors occurred!
</span></code></pre></td></tr></table></div></figure>


<p>I looked into this and &hellip; this seemed like a bug ? WTF. Anyway I just edited this out of <code>CMakeLists.txt</code> and tried again.</p>

<p>That worked! So then <code>make &amp;&amp; sudo make install</code> as usual.</p>

<p>Note: I also had to copy the <code>libcxxabi</code> library built above to a global location, since I got an error trying to build <code>libcxx</code> without it</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>/usr/bin/ld: cannot find -lc++abi
</span></code></pre></td></tr></table></div></figure>


<p>After a while it occurred to me: <a href="http://memegenerator.net/instance/41718307">one does not simply copy a library to /usr/local/lib</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>sudo ldconfig -f /etc/ld.so.conf.d/libc.conf
</span><span class='line'><span class="nv">$ </span>ldconfig -p | grep c++abi
</span><span class='line'>...
</span><span class='line'>        libc++abi.so.1 <span class="o">(</span>libc6,x86-64<span class="o">)</span> <span class="o">=</span>&gt; /usr/local/lib/libc++abi.so.1
</span></code></pre></td></tr></table></div></figure>


<p>Hmm not quite. Some <a href="http://comments.gmane.org/gmane.comp.compilers.clang.devel/30074">discussion I came across</a> suggests a different format for the symlink</p>

<p>Yup, this was fixed by <code>sudo ln libc++abi.so.1.0 libc++abi.so</code></p>

<p>Now, adding this library works:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>/usr/clang_3_3/bin/clang++ -std<span class="o">=</span>c++11 -stdlib<span class="o">=</span>libc++ -L/usr/lib -I/opt/boost/boost_1_54_0 hello-world.cpp -o hello-world -lc++abi
</span></code></pre></td></tr></table></div></figure>


<p>Just to confirm, I also verified that the toy <code>wget</code> equivalent I had built with the Poco libraries works with Clang, and it does.</p>

      
      
    </div>
  </div>



    </article>
    
    <hr>
    
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2013-09-29T00:00:00+00:00" pubdate data-updated="true">Sep 29<span>th</span>, 2013</time></h5>
          <div class="row-fluid">
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/c++/"><span class="badge">C++</span></a>
          
          <a href="/blog/categories/http/"><span class="badge">HTTP</span></a>
          
          <a href="/blog/categories/poco/"><span class="badge">Poco</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2013/09/29/http-client-with-poco/">Basic HTTP Client with Poco</a></h1>
      <p>After my previous terrible experience with <code>cpp-netlib</code>, I was very very pleasantly surprised by how well this went.</p>

<p>You can get the Poco C++ libraries <a href="http://pocoproject.org/">here</a></p>

<p>This is the short <code>wget</code> equivalent &hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;algorithm&gt;  </span><span class="c1">// for copy</span>
</span><span class='line'><span class="cp">#include &lt;iterator&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string&gt;</span>
</span><span class='line'><span class="cp">#include &lt;iostream&gt;   </span><span class="c1">// for cout, istream</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;Poco/Exception.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;Poco/Net/HTTPClientSession.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;Poco/Net/HTTPRequest.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;Poco/Net/HTTPResponse.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;Poco/Path.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;Poco/URI.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="n">using</span> <span class="n">string</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Usage: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &lt;url&gt;&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">try</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Initialize session</span>
</span><span class='line'>    <span class="n">Poco</span><span class="o">::</span><span class="n">URI</span> <span class="n">uri</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>    <span class="n">Poco</span><span class="o">::</span><span class="n">Net</span><span class="o">::</span><span class="n">HTTPClientSession</span> <span class="n">client_session</span><span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="n">getHost</span><span class="p">(),</span> <span class="n">uri</span><span class="p">.</span><span class="n">getPort</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Prepare and send request</span>
</span><span class='line'>    <span class="n">string</span> <span class="n">path</span><span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="n">getPathAndQuery</span><span class="p">());</span>
</span><span class='line'>    <span class="n">Poco</span><span class="o">::</span><span class="n">Net</span><span class="o">::</span><span class="n">HTTPRequest</span> <span class="n">req</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">Net</span><span class="o">::</span><span class="n">HTTPRequest</span><span class="o">::</span><span class="n">HTTP_GET</span><span class="p">,</span>
</span><span class='line'>        <span class="n">path</span><span class="p">,</span> <span class="n">Poco</span><span class="o">::</span><span class="n">Net</span><span class="o">::</span><span class="n">HTTPMessage</span><span class="o">::</span><span class="n">HTTP_1_1</span><span class="p">);</span>
</span><span class='line'>    <span class="n">client_session</span><span class="p">.</span><span class="n">sendRequest</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Get response</span>
</span><span class='line'>    <span class="n">Poco</span><span class="o">::</span><span class="n">Net</span><span class="o">::</span><span class="n">HTTPResponse</span> <span class="n">res</span><span class="p">;</span>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span> <span class="n">is</span> <span class="o">=</span> <span class="n">client_session</span><span class="p">.</span><span class="n">receiveResponse</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Print to standard output</span>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream_iterator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">is</span><span class="p">),</span>
</span><span class='line'>        <span class="n">std</span><span class="o">::</span><span class="n">istream_iterator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(),</span>
</span><span class='line'>        <span class="n">std</span><span class="o">::</span><span class="n">ostream_iterator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">Exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Exception: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Completed communication&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Thanks to my struggles getting the previous <code>cpp-netlib</code> example to build, I at least got very familiar with <code>cmake</code>. As a result, getting this example to build was a breeze:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='cmake'><span class='line'><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">2.8</span><span class="p">)</span>
</span><span class='line'><span class="nb">project</span><span class="p">(</span><span class="s">hello-world</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nb">add_definitions</span><span class="p">(</span><span class="s">-std=c++11</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Search paths</span>
</span><span class='line'><span class="nb">include_directories</span><span class="p">(</span>
</span><span class='line'>  <span class="s">/opt/boost/boost_1_54_0</span>
</span><span class='line'>  <span class="s">/usr/local/include</span><span class="p">)</span>
</span><span class='line'><span class="nb">link_directories</span><span class="p">(</span>
</span><span class='line'>  <span class="s">/opt/boost/boost_1_54_0/stage/lib</span>
</span><span class='line'>  <span class="s">/usr/local/lib</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Boost dependencies</span>
</span><span class='line'><span class="nb">find_package</span><span class="p">(</span><span class="s">Boost</span> <span class="s">1.51</span> <span class="s">REQUIRED</span> <span class="s">system</span> <span class="s">regex</span><span class="p">)</span>
</span><span class='line'><span class="nb">set</span><span class="p">(</span><span class="s">BOOST_LIBS</span>
</span><span class='line'>  <span class="o">${</span><span class="nv">Boost_SYSTEM_LIBRARY</span><span class="o">}</span>
</span><span class='line'>  <span class="o">${</span><span class="nv">Boost_REGEX_LIBRARY</span><span class="o">}</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Other external libraries</span>
</span><span class='line'><span class="nb">find_package</span><span class="p">(</span><span class="s">OpenSSL</span><span class="p">)</span>
</span><span class='line'><span class="nb">find_library</span><span class="p">(</span><span class="s">LIBCRYPTO</span> <span class="s">crypto</span><span class="p">)</span>
</span><span class='line'><span class="nb">find_library</span><span class="p">(</span><span class="s">POCO_FOUNDATION</span> <span class="s">PocoFoundation</span><span class="p">)</span>
</span><span class='line'><span class="nb">find_library</span><span class="p">(</span><span class="s">POCO_NET</span> <span class="s">PocoNet</span><span class="p">)</span>
</span><span class='line'><span class="nb">set</span><span class="p">(</span><span class="s">EXTERNAL_LIBS</span>
</span><span class='line'>  <span class="o">${</span><span class="nv">OPENSSL_LIBRARIES</span><span class="o">}</span>
</span><span class='line'>  <span class="o">${</span><span class="nv">LIBCRYPTO</span><span class="o">}</span>
</span><span class='line'>  <span class="o">${</span><span class="nv">POCO_FOUNDATION</span><span class="o">}</span>
</span><span class='line'>  <span class="o">${</span><span class="nv">POCO_NET</span><span class="o">}</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Our final output</span>
</span><span class='line'><span class="nb">add_executable</span><span class="p">(</span><span class="s">hello-world</span> <span class="s">hello-world.cpp</span><span class="p">)</span>
</span><span class='line'><span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">hello-world</span>
</span><span class='line'>  <span class="o">${</span><span class="nv">BOOST_LIBS</span><span class="o">}</span>
</span><span class='line'>  <span class="o">${</span><span class="nv">EXTERNAL_LIBS</span><span class="o">}</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And it worked fine too:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">time</span> ./hello-world http://www.google.com
</span><span class='line'>&lt;html&gt;&lt;head&gt;&lt;metahttp-equiv<span class="o">=</span><span class="s2">&quot;content-type&quot;</span><span class="nv">content</span><span class="o">=</span><span class="err">&quot;</span>text/html;charset<span class="o">=</span> ...<span class="o">(</span>skipped rest<span class="o">)</span>
</span><span class='line'>real    0m0.424s
</span><span class='line'>user    0m0.004s
</span><span class='line'>sys     0m0.012s
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;m sure I&rsquo;ll be using more of POCO in the future!</p>

      
      
    </div>
  </div>



    </article>
    
    <hr>
    
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2013-09-09T00:00:00+00:00" pubdate data-updated="true">Sep 9<span>th</span>, 2013</time></h5>
          <div class="row-fluid">
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/cmake/"><span class="badge">CMake</span></a>
          
          <a href="/blog/categories/cppnetlib/"><span class="badge">CppNetlib</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2013/09/09/building-stuff-part-2/">Learning how to build (part 2)</a></h1>
      <p>I wanted to get an idea of the state of open source C++ tools and idioms, so I decided to pick something small to start with.</p>

<h2>Raw materials: getting the libraries</h2>

<p>I already had <code>boost</code> and newly built versions of <code>gcc</code> and <code>libstdc++</code>.</p>

<p>First, I got another networking library I had heard about, <a href="https://github.com/google/cpp-netlib"><code>cpp-netlib</code></a>. (<code>git clone</code>, then <code>git submodule update</code>)</p>

<p>Next, I got a logging library <a href="https://code.google.com/p/google-glog/"><code>glog</code></a>, and a perf library <a href="https://code.google.com/p/gperftools/"><code>gperftools</code></a></p>

<p>(Both of these required me to download a <code>.tar.gz</code> file that needed to be uncompressed)</p>

<p>At this point, there was already a problem of how to build stuff (!)</p>

<p>Glog/Gperftools came with the usual <code>autoconf</code> system, but <code>cpp-netlib</code> had to be built with <code>CMake</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>cmake ~/Documents/Code/AmpWorld/cpp-netlib <span class="se">\</span>
</span><span class='line'>  -DCMAKE_BUILD_TYPE<span class="o">=</span>Debug <span class="se">\</span>
</span><span class='line'>  -DCMAKE_C_COMPILER<span class="o">=</span>/usr/clang_3_3/bin/clang <span class="se">\</span>
</span><span class='line'>  -DCMAKE_CXX_COMPILER<span class="o">=</span>/usr/clang_3_3/bin/clang++
</span></code></pre></td></tr></table></div></figure>


<p>Initial problems getting this to work (in roughly chronological order) were:</p>

<ul>
<li>I had run <code>git submodule update</code> without <code>git submodule init</code>, so I had to clear out <code>CMake</code> temporaries, then run <code>init</code> and <code>update</code> to get them</li>
<li><code>Gperftools</code> didn&rsquo;t build on my machine, and required me to first install <code>libunwind</code></li>
<li>I had not specified boost include dirs, I had to run (in my case) <code>export BOOST_INCLUDEDIR=/opt/boost/boost_1_54_0</code></li>
<li>I had not installed the boost libraries that were <em>not</em> header-only (filesystem, regex, date_time, unit_test_framework, etc)</li>
<li>I couldn&rsquo;t figure out how to pass the right include paths through cmake, I ended up setting the environment variables instead
  (In my case this meant <code>export C_INCLUDE_PATH=255</code>.</li>
<li>After these four, I still got compilation errors
(e.g. <code>boost/bind/mem_fn_template.hpp:610:30: error: no matching function for call to 'get_pointer'</code>)</li>
<li>I added <code>-DCMAKE_LIBRARY_PATH=/usr/gcc_4_7/lib64</code> to cmake, and ran <code>make</code> again</li>
<li>Now I had different linker errors &hellip; <em>sigh</em> &hellip; undefined references to basic C++ library symbols like <code>string</code> in boost code</li>
<li>Guessed that this might have been because I had built <em>boost</em> with <em>gcc</em></li>
<li>Tried building the relevant Boost libraries again. This time when I ran &ldquo;<code>bootstrap.sh</code>&rdquo; again, I got:
<code>error: No best alternative for libs/coroutine/build/allocator_sources</code></li>
<li>WTF (!) &hellip; found <a href="http://superuser.com/questions/614472/error-while-installing-boost-1-54">a Superuser post that explained</a> a workaround,
which was to edit <code>libs/coroutine/build/Jamfile.v2</code>
&hellip; and now I get <em>other</em> weird errors: <code>./boost/python/detail/wrap_python.hpp:75:24: fatal error: patchlevel.h: No such file or directory</code></li>
<li>Needed to install stuff: <code>sudo apt-get install python-dev</code></li>
<li>Now everything <em>almost</em> worked, but one of the files failed to compile:
<code>cpp-netlib/http/src/network/protocol/http/client.ipp:18: undefined reference to network::logging::log(network::logging::log_record const&amp;)'</code></li>
<li>This error was truly bizarre because I located the source file that had this call (<code>logging/src/network/logging/logging.hpp</code>)
and it very explicitly disabled the copy constructor that the linker was complaining of being undefined !</li>
<li>Digging around in the corresponding <code>CMakeLists.txt</code> suggests this might possibly be due to logging being disabled</li>
<li>(<em>Will this never end ?</em>) <code>/usr/bin/ld: cannot find -lcppnetlib-logging</code></li>
<li>Fine, just turn of the f&amp;*ing tests</li>
</ul>


<p>So finally, this is what worked:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">export </span><span class="nv">CC</span><span class="o">=</span>/usr/gcc_4_7/bin/gcc4.7
</span><span class='line'><span class="nb">export </span><span class="nv">CXX</span><span class="o">=</span>/usr/gcc_4_7/bin/g++4.7
</span><span class='line'><span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>
</span><span class='line'>  /usr/gcc_4_7/lib:/usr/gcc_4_7/lib64:/opt/boost/boost_1_54_0/stage/lib:<span class="nv">$LD_LIBRARY_PATH</span>
</span><span class='line'>/usr/local/bin/cmake <span class="se">\</span>
</span><span class='line'> -DCPP-NETLIB_BUILD_TESTS<span class="o">=</span>OFF <span class="se">\</span>
</span><span class='line'> -DCPP-NETLIB_BUILD_EXAMPLES<span class="o">=</span>ON <span class="se">\</span>
</span><span class='line'> -DCPP-NETLIB_DISABLE_LOGGING<span class="o">=</span>OFF <span class="se">\</span>
</span><span class='line'> -DCMAKE_BUILD_TYPE<span class="o">=</span>Debug <span class="se">\</span>
</span><span class='line'> -DCMAKE_INCLUDE_PATH<span class="o">=</span>/usr/gcc_4_7/include/c++/4.7.3/ <span class="se">\</span>
</span><span class='line'> -DCMAKE_LIBRARY_PATH<span class="o">=</span>/usr/gcc_4_7/lib64 <span class="se">\</span>
</span><span class='line'> ~/Documents/Code/AmpWorld/cpp-netlib
</span></code></pre></td></tr></table></div></figure>


<p>Finally, even this didn&rsquo;t install the libraries where I wanted them. Finally I gave up and just hacked it up:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="sb">`</span><span class="k">for </span>f in <span class="sb">`</span>find /home/agam/Documents/Code/AmpWorld/cpp-netlib/ | grep <span class="s1">&#39;lib.*a$&#39;</span><span class="sb">`</span>; <span class="se">\</span>
</span><span class='line'> <span class="k">do </span>sudo cp <span class="nv">$f</span> /opt/cpp-static-libs/; <span class="k">done</span><span class="sb">`</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Into the furnace: a simple sample</h2>

<p>So far so good. Now it was &ldquo;hello world&rdquo; time (something that used atleast two of these libraries).</p>

<p>Or for a more basic step, replicate <a href="http://cpp-netlib.org/0.10.1/examples/http/hello_world_client.html">cpp-netlib&rsquo;s hello world</a> first.</p>

<p>This was the initial version, from the web page referred above.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;protocol/http/client.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string&gt;                  </span>
</span><span class='line'><span class="cp">#include &lt;iostream&gt;                </span>
</span><span class='line'>
</span><span class='line'><span class="n">namespace</span> <span class="n">http</span> <span class="o">=</span> <span class="n">network</span><span class="o">::</span><span class="n">http</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Usage: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;&lt;url&gt;&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">try</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">http</span><span class="o">::</span><span class="n">client</span> <span class="n">client</span><span class="p">;</span>
</span><span class='line'>    <span class="n">http</span><span class="o">::</span><span class="n">client</span><span class="o">::</span><span class="n">request</span> <span class="n">request</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>    <span class="n">http</span><span class="o">::</span><span class="n">client</span><span class="o">::</span><span class="n">response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Print to standard output  </span>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Received: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">body</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>  <span class="c1">// end namespace                </span>
</span></code></pre></td></tr></table></div></figure>


<p>(The version in the example on the web page referred above was different in many ways, I&rsquo;ll leave that as an exercise for the reader :) )</p>

<p>Trying to compile it thus:</p>

<p><code>g++4.7 -std=c++11 hello-world.cpp -Icpp-netlib/http/src/ -Icpp-netlib/message/src/ -Icpp-netlib/uri/src/  -I/opt/boost/boost_1_54_0 -lcppnetlib-http-client</code></p>

<p>(almost there, now I get <code>/usr/bin/ld: cannot find -lcppnetlib-http-client</code>)</p>

<p>After a round of tacking on libraries while I continued to get <code>undefined reference</code> errors, I gave up and decided it was time to get a makefile ready.</p>

<p>For reference (or shame, or disgust, or trivia), the one-liner I had at this point had grown to</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>g++4.7 hello-world.cpp <span class="se">\</span>
</span><span class='line'>  -L/opt/cpp-static-libs/ <span class="se">\</span>
</span><span class='line'>  -lcppnetlib-uri -lcppnetlib-http-client -lcppnetlib-http-message-wrappers <span class="se">\</span>
</span><span class='line'>  -lcppnetlib-http-client-connections -lcppnetlib-constants <span class="se">\</span>
</span><span class='line'>  -lcppnetlib-http-message -lcppnetlib-message -lcppnetlib-logging <span class="se">\</span>
</span><span class='line'>  -L/opt/boost/boost_1_54_0/stage/lib/ -lboost_system -lboost_regex <span class="se">\</span>
</span><span class='line'>  -lssl -lcrypt -std<span class="o">=</span>c++11 <span class="se">\</span>
</span><span class='line'>  -Icpp-netlib/http/src/ -Icpp-netlib/message/src/ -Icpp-netlib/uri/src/ <span class="se">\</span>
</span><span class='line'>  -I/opt/boost/boost_1_54_0
</span></code></pre></td></tr></table></div></figure>


<h2>Scaffolding and Fire: Creating a makefile</h2>

<p>Time to learn CMake ! Here&rsquo;s <a href="http://mathnathan.com/2010/07/getting-started-with-cmake/">a good tutorial</a> or actually here&rsquo;s <a href="http://web.cs.swarthmore.edu/~adanner/tips/cmake.php">a better one</a></p>

<p>This is what I came up with for <code>CMakeLists.txt</code> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='cmake'><span class='line'><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">2.8</span><span class="p">)</span>
</span><span class='line'><span class="nb">project</span><span class="p">(</span><span class="s">hello-world</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nb">add_definitions</span><span class="p">(</span><span class="s">-std=c++11</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_FIND_LIBRARY_SUFFIXES</span> <span class="s">.a</span> <span class="o">${</span><span class="nv">CMAKE_FIND_LIBRARY_SUFFIXES</span><span class="o">}</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Search paths</span>
</span><span class='line'><span class="nb">set</span><span class="p">(</span><span class="s">CPP-NETLIB-SRC</span>
</span><span class='line'>  <span class="s">/home/agam/Documents/Code/AmpWorld/cpp-netlib</span><span class="p">)</span>
</span><span class='line'><span class="nb">include_directories</span><span class="p">(</span>
</span><span class='line'>  <span class="s">/opt/boost/boost_1_54_0</span>
</span><span class='line'>  <span class="s">/opt/cpp-static-libs</span>
</span><span class='line'>  <span class="o">${</span><span class="nv">CPP-NETLIB-SRC</span><span class="o">}</span><span class="s">/http/src</span>
</span><span class='line'>  <span class="o">${</span><span class="nv">CPP-NETLIB-SRC</span><span class="o">}</span><span class="s">/message/src</span>
</span><span class='line'>  <span class="o">${</span><span class="nv">CPP-NETLIB-SRC</span><span class="o">}</span><span class="s">/uri/src</span>
</span><span class='line'>  <span class="o">${</span><span class="nv">CPP-NETLIB-SRC</span><span class="o">}</span><span class="s">/logging/src</span><span class="p">)</span>
</span><span class='line'><span class="nb">link_directories</span><span class="p">(</span>
</span><span class='line'>  <span class="s">/opt/boost/boost_1_54_0/stage/lib</span>
</span><span class='line'>  <span class="s">/opt/cpp-static-libs</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># CppNetlib libraries                                                                                                                  </span>
</span><span class='line'><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_FIND_LIBRARY_SUFFIXES</span> <span class="s">.a</span> <span class="o">${</span><span class="nv">CMAKE_FIND_LIBRARY_SUFFIXES</span><span class="o">}</span><span class="p">)</span>
</span><span class='line'><span class="nb">set</span><span class="p">(</span><span class="s">CPP-NETLIB-LIBS,</span>
</span><span class='line'>  <span class="s">cppnetlib-uri</span>
</span><span class='line'>  <span class="s">cppnetlib-message</span>
</span><span class='line'>  <span class="s">cppnetlib-message-directives</span>
</span><span class='line'>  <span class="s">cppnetlib-message-wrappers</span>
</span><span class='line'>  <span class="s">cppnetlib-http-message-wrappers</span>
</span><span class='line'>  <span class="s">cppnetlib-http-message</span>
</span><span class='line'>  <span class="s">cppnetlib-constants</span>
</span><span class='line'>  <span class="s">cppnetlib-http-client</span>
</span><span class='line'>  <span class="s">cppnetlib-http-client-connections</span>
</span><span class='line'>  <span class="s">cppnetlib-logging</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Boost dependencies</span>
</span><span class='line'><span class="nb">find_package</span><span class="p">(</span><span class="s">Boost</span> <span class="s">1.51</span> <span class="s">REQUIRED</span> <span class="s">system</span> <span class="s">regex</span><span class="p">)</span>
</span><span class='line'><span class="nb">set</span><span class="p">(</span><span class="s">BOOST_LIBS,</span>
</span><span class='line'>  <span class="o">${</span><span class="nv">Boost_SYSTEM_LIBRARY</span><span class="o">}</span>
</span><span class='line'>  <span class="o">${</span><span class="nv">Boost_REGEX_LIBRARY</span><span class="o">}</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Other external libraries                                                                                                             </span>
</span><span class='line'><span class="nb">set</span><span class="p">(</span><span class="s">EXTERNAL_LIBS,</span>
</span><span class='line'>  <span class="s">ssl</span>
</span><span class='line'>  <span class="s">crypto</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Our final output</span>
</span><span class='line'><span class="nb">add_executable</span><span class="p">(</span><span class="s">hello-world</span> <span class="s">hello-world.cpp</span><span class="p">)</span>
</span><span class='line'><span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">hello-world</span>
</span><span class='line'>  <span class="o">${</span><span class="nv">BOOST_LIBS</span><span class="o">}</span>
</span><span class='line'>  <span class="o">${</span><span class="nv">EXTERNAL_LIBS</span><span class="o">}</span>
</span><span class='line'>  <span class="o">${</span><span class="nv">CPP-NETLIB-LIBS</span><span class="o">}</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>However when I tried to build,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>make
</span><span class='line'>Scanning dependencies of target hello-world
</span><span class='line'><span class="o">[</span>100%<span class="o">]</span> Building CXX object CMakeFiles/hello-world.dir/hello-world.cpp.o
</span><span class='line'>Linking CXX executable hello-world
</span><span class='line'>CMakeFiles/hello-world.dir/hello-world.cpp.o: In <span class="k">function</span> <span class="sb">`</span><span class="o">(</span>anonymous namespace<span class="o">)</span>::get_filename<span class="o">(</span>network::uri const&amp;<span class="o">)</span><span class="s1">&#39;:</span>
</span><span class='line'><span class="s1">hello-world.cpp:(.text+0x22): undefined reference to `network::uri::path() const&#39;</span>
</span><span class='line'>CMakeFiles/hello-world.dir/hello-world.cpp.o: In <span class="k">function</span> <span class="sb">`</span>main<span class="s1">&#39;:</span>
</span><span class='line'><span class="s1">hello-world.cpp:(.text+0x1ee): undefined reference to `network::http::client::client()&#39;</span>
</span><span class='line'>hello-world.cpp:<span class="o">(</span>.text+0x231<span class="o">)</span>: undefined reference to <span class="sb">`</span>network::http::request::request<span class="o">(</span>std::string const&amp;<span class="o">)</span><span class="err">&#39;</span>
</span><span class='line'>...
</span><span class='line'>&lt;more undefined reference errors&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Eventually (minutes, hours, later! I&rsquo;ll spare you the pain) and after becoming lightly skilled in the arts of CMake, I realized that what I needed to do (or one of the things that I <em>could</em> do) was to explicitly declare the path of the static library, and specify their order.</p>

<p>So I then ended up with something like this (omitting the common parts with the listing above):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='cmake'><span class='line'><span class="c"># Specify static libraries explicitly to make Cmake happy</span>
</span><span class='line'><span class="nb">add_library</span><span class="p">(</span><span class="s">CPPNETLIB_URI</span> <span class="s">STATIC</span> <span class="s">IMPORTED</span><span class="p">)</span>
</span><span class='line'><span class="nb">set_property</span><span class="p">(</span><span class="s">TARGET</span> <span class="s">CPPNETLIB_URI</span> <span class="s">PROPERTY</span>
</span><span class='line'>  <span class="s">IMPORTED_LOCATION</span> <span class="s">/opt/cpp-static-libs/libcppnetlib-uri.a</span><span class="p">)</span>
</span><span class='line'><span class="nb">add_library</span><span class="p">(</span><span class="s">CPPNETLIB_MESSAGE</span> <span class="s">STATIC</span> <span class="s">IMPORTED</span><span class="p">)</span>
</span><span class='line'><span class="nb">set_property</span><span class="p">(</span><span class="s">TARGET</span> <span class="s">CPPNETLIB_MESSAGE</span> <span class="s">PROPERTY</span>
</span><span class='line'>  <span class="s">IMPORTED_LOCATION</span> <span class="s">/opt/cpp-static-libs/libcppnetlib-message.a</span><span class="p">)</span>
</span><span class='line'><span class="nb">add_library</span><span class="p">(</span><span class="s">CPPNETLIB_MESSAGE_DIRECTIVES</span> <span class="s">STATIC</span> <span class="s">IMPORTED</span><span class="p">)</span>
</span><span class='line'><span class="nb">set_property</span><span class="p">(</span><span class="s">TARGET</span> <span class="s">CPPNETLIB_MESSAGE_DIRECTIVES</span> <span class="s">PROPERTY</span>
</span><span class='line'>  <span class="s">IMPORTED_LOCATION</span> <span class="s">/opt/cpp-static-libs/libcppnetlib-message-directives.a</span><span class="p">)</span>
</span><span class='line'><span class="nb">add_library</span><span class="p">(</span><span class="s">CPPNETLIB_MESSAGE_WRAPPERS</span> <span class="s">STATIC</span> <span class="s">IMPORTED</span><span class="p">)</span>
</span><span class='line'><span class="nb">set_property</span><span class="p">(</span><span class="s">TARGET</span> <span class="s">CPPNETLIB_MESSAGE_WRAPPERS</span> <span class="s">PROPERTY</span>
</span><span class='line'>  <span class="s">IMPORTED_LOCATION</span> <span class="s">/opt/cpp-static-libs/libcppnetlib-message-wrappers.a</span><span class="p">)</span>
</span><span class='line'><span class="nb">add_library</span><span class="p">(</span><span class="s">CPPNETLIB_HTTP_MESSAGE</span> <span class="s">STATIC</span> <span class="s">IMPORTED</span><span class="p">)</span>
</span><span class='line'><span class="nb">set_property</span><span class="p">(</span><span class="s">TARGET</span> <span class="s">CPPNETLIB_HTTP_MESSAGE</span> <span class="s">PROPERTY</span>
</span><span class='line'>  <span class="s">IMPORTED_LOCATION</span> <span class="s">/opt/cpp-static-libs/libcppnetlib-http-message.a</span><span class="p">)</span>
</span><span class='line'><span class="nb">add_library</span><span class="p">(</span><span class="s">CPPNETLIB_HTTP_MESSAGE_WRAPPERS</span> <span class="s">STATIC</span> <span class="s">IMPORTED</span><span class="p">)</span>
</span><span class='line'><span class="nb">set_property</span><span class="p">(</span><span class="s">TARGET</span> <span class="s">CPPNETLIB_HTTP_MESSAGE_WRAPPERS</span> <span class="s">PROPERTY</span>
</span><span class='line'>  <span class="s">IMPORTED_LOCATION</span> <span class="s">/opt/cpp-static-libs/libcppnetlib-http-message-wrappers.a</span><span class="p">)</span>
</span><span class='line'><span class="nb">add_library</span><span class="p">(</span><span class="s">CPPNETLIB_CONSTANTS</span> <span class="s">STATIC</span> <span class="s">IMPORTED</span><span class="p">)</span>
</span><span class='line'><span class="nb">set_property</span><span class="p">(</span><span class="s">TARGET</span> <span class="s">CPPNETLIB_CONSTANTS</span> <span class="s">PROPERTY</span>
</span><span class='line'>  <span class="s">IMPORTED_LOCATION</span> <span class="s">/opt/cpp-static-libs/libcppnetlib-constants.a</span><span class="p">)</span>
</span><span class='line'><span class="nb">add_library</span><span class="p">(</span><span class="s">CPPNETLIB_HTTP_CLIENT</span> <span class="s">STATIC</span> <span class="s">IMPORTED</span><span class="p">)</span>
</span><span class='line'><span class="nb">set_property</span><span class="p">(</span><span class="s">TARGET</span> <span class="s">CPPNETLIB_HTTP_CLIENT</span> <span class="s">PROPERTY</span>
</span><span class='line'>  <span class="s">IMPORTED_LOCATION</span> <span class="s">/opt/cpp-static-libs/libcppnetlib-http-client.a</span><span class="p">)</span>
</span><span class='line'><span class="nb">add_library</span><span class="p">(</span><span class="s">CPPNETLIB_HTTP_CLIENT_CONNECTINS</span> <span class="s">STATIC</span> <span class="s">IMPORTED</span><span class="p">)</span>
</span><span class='line'><span class="nb">set_property</span><span class="p">(</span><span class="s">TARGET</span> <span class="s">CPPNETLIB_HTTP_CLIENT_CONNECTINS</span> <span class="s">PROPERTY</span>
</span><span class='line'>  <span class="s">IMPORTED_LOCATION</span> <span class="s">/opt/cpp-static-libs/libcppnetlib-http-client-connections.a</span><span class="p">)</span>
</span><span class='line'><span class="nb">add_library</span><span class="p">(</span><span class="s">CPPNETLIB_LOGGING</span> <span class="s">STATIC</span> <span class="s">IMPORTED</span><span class="p">)</span>
</span><span class='line'><span class="nb">set_property</span><span class="p">(</span><span class="s">TARGET</span> <span class="s">CPPNETLIB_LOGGING</span> <span class="s">PROPERTY</span>
</span><span class='line'>  <span class="s">IMPORTED_LOCATION</span> <span class="s">/opt/cpp-static-libs/libcppnetlib-logging.a</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nb">set</span><span class="p">(</span><span class="s">CPPNETLIB_LIBS</span>
</span><span class='line'>  <span class="s">CPPNETLIB_MESSAGE_WRAPPERS</span>
</span><span class='line'>  <span class="s">CPPNETLIB_HTTP_MESSAGE</span>
</span><span class='line'>  <span class="s">CPPNETLIB_MESSAGE</span>
</span><span class='line'>  <span class="s">CPPNETLIB_HTTP_CLIENT</span>
</span><span class='line'>  <span class="s">CPPNETLIB_MESSAGE_DIRECTIVES</span>
</span><span class='line'>  <span class="s">CPPNETLIB_HTTP_CLIENT_CONNECTINS</span>
</span><span class='line'>  <span class="s">CPPNETLIB_URI</span>
</span><span class='line'>  <span class="s">CPPNETLIB_LOGGING</span>
</span><span class='line'>  <span class="s">CPPNETLIB_CONSTANTS</span>
</span><span class='line'>  <span class="s">CPPNETLIB_HTTP_MESSAGE_WRAPPERS</span>
</span><span class='line'>  <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, not only did I have to set the <code>IMPORTED_LOCATION</code> of each library (there <em>has</em> to be a better way to do this, doesn&rsquo;t there ?!) but I also had to juggle around their order relative to each other before passing <code>${CPPNETLIB_LIBS}</code> to <code>target_link_libraries</code></p>

<h2>Forging a networking hello-world, or &lsquo;all I want is a wget&rsquo;</h2>

<p>Once this was done, I could successfully do the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>mkdir build <span class="o">&amp;&amp;</span> <span class="nb">cd </span>build
</span><span class='line'><span class="nv">$ </span>cmake ..
</span><span class='line'><span class="nv">$ </span>make
</span></code></pre></td></tr></table></div></figure>


<p>Scanning dependencies of target hello-world
[100%] Building CXX object CMakeFiles/hello-world.dir/hello-world.cpp.o
Linking CXX executable hello-world
[100%] Built target hello-world</p>

<p>About %$#ing time, eh ?</p>

<p>Well, it still doesn&rsquo;t <em>quite</em> work.</p>

<p>Before we see the non-working case, it&rsquo;s useful to see what happens on bad input:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>./hello-world foo
</span><span class='line'><span class="o">[</span>network http/client/base.ipp:78<span class="o">]</span> client_base_pimpl::client_base_pimpl<span class="o">(</span>client_options const &amp;<span class="o">)</span>
</span><span class='line'><span class="o">[</span>network http/client/base.ipp:80<span class="o">]</span> creating owned io_service.
</span><span class='line'><span class="o">[</span>network http/client/base.ipp:85<span class="o">]</span> creating owned simple_connection_manager
</span><span class='line'><span class="o">[</span>network http/client/simple_connection_manager.ipp:24<span class="o">]</span> simple_connection_manager_pimpl::simple_connection_manager_pimpl<span class="o">(</span>client_options const &amp;<span class="o">)</span>
</span><span class='line'><span class="o">[</span>network http/client/simple_connection_manager.ipp:26<span class="o">]</span> creating simple connection factory
</span><span class='line'><span class="o">[</span>network http/client/connection/simple_connection_factory.ipp:57<span class="o">]</span> simple_connection_factory::simple_connection_factory<span class="o">()</span>
</span><span class='line'><span class="o">[</span>network http/client/connection/connection_delegate_factory.ipp:22<span class="o">]</span> connection_delegate_factory::connection_delegate_factory<span class="o">()</span>
</span><span class='line'><span class="o">[</span>network http/client/connection/resolver_delegate_factory.ipp:18<span class="o">]</span> resolver_delegate_factory::resolver_delegate_factory<span class="o">()</span>
</span><span class='line'><span class="o">[</span>network http/client/connection/simple_connection_factory.ipp:33<span class="o">]</span> simple_connection_factory_pimpl::simple_connection_factory_pimpl<span class="o">(</span>...<span class="o">)</span>
</span><span class='line'><span class="o">[</span>network http/client/simple_connection_manager.ipp:61<span class="o">]</span> simple_connection_manager::simple_connection_manager<span class="o">(</span>client_options const &amp;<span class="o">)</span>
</span><span class='line'><span class="o">[</span>network http/client/base.ipp:46<span class="o">]</span> client_base::client_base<span class="o">()</span>
</span><span class='line'><span class="o">[</span>network http/client/facade.ipp:19<span class="o">]</span> basic_client_facade::basic_client_facade<span class="o">()</span>
</span><span class='line'><span class="o">[</span>network http/client.ipp:18<span class="o">]</span> client::client<span class="o">()</span>
</span><span class='line'><span class="o">[</span>network http/client/base.ipp:68<span class="o">]</span> client_base::~client_base<span class="o">()</span>
</span><span class='line'><span class="o">[</span>network http/client/base.ipp:98<span class="o">]</span> client_base_pimpl::~client_base_pimpl<span class="o">()</span>
</span><span class='line'><span class="o">[</span>network http/client/simple_connection_manager.ipp:73<span class="o">]</span> simple_connection_manager::reset<span class="o">()</span>
</span><span class='line'><span class="o">[</span>network http/client/simple_connection_manager.ipp:83<span class="o">]</span> simple_connection_manager::~simple_connection_manager<span class="o">()</span>
</span><span class='line'><span class="o">[</span>network http/client/simple_connection_manager.ipp:48<span class="o">]</span> simple_connection_manager_pimpl::~simple_connection_manager_pimpl<span class="o">()</span>
</span><span class='line'><span class="o">[</span>network http/client/connection/simple_connection_factory.ipp:82<span class="o">]</span> simple_connection_factory::~simple_connection_factory<span class="o">()</span>
</span><span class='line'><span class="o">[</span>network http/client/connection/resolver_delegate_factory.ipp:29<span class="o">]</span> resolver_delegate_factory::~resolver_delegate_factory<span class="o">()</span>
</span><span class='line'><span class="o">[</span>network http/client/connection/connection_delegate_factory.ipp:47<span class="o">]</span> connection_delegate_factory::~connection_delegate_factory<span class="o">()</span>
</span><span class='line'><span class="o">[</span>network http/client/connection_manager.ipp:16<span class="o">]</span> connection_manager::~connection_manager<span class="o">()</span>
</span><span class='line'>Exception: Unable to parse URI string.
</span></code></pre></td></tr></table></div></figure>


<p>When I ran <code>time ./hello-world http://www.google.com</code>, I got</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>real    4m0.135s
</span><span class='line'>user    0m0.020s
</span><span class='line'>sys     0m0.012s
</span></code></pre></td></tr></table></div></figure>


<p>There were a series of calls of the following form:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>network http/client/connection/normal_delegate.ipp:38<span class="o">]</span> normal_delegate::read_some<span class="o">(</span>...<span class="o">)</span>
</span><span class='line'><span class="o">[</span>network http/client/connection/normal_delegate.ipp:39<span class="o">]</span> scheduling asynchronous <span class="nb">read </span>some...
</span><span class='line'><span class="o">[</span>network http/client/connection/normal_delegate.ipp:41<span class="o">]</span> scheduled asynchronous <span class="nb">read </span>some...
</span><span class='line'><span class="o">[</span>network http/client/connection/async_normal.ipp:237<span class="o">]</span> http_async_connection_pimpl::handle_received_data<span class="o">(</span>...<span class="o">)</span>
</span><span class='line'><span class="o">[</span>network http/client/connection/async_normal.ipp:252<span class="o">]</span> processing data chunk, no error encountered so far...
</span><span class='line'><span class="o">[</span>network http/client/connection/async_normal.ipp:380<span class="o">]</span> parsing body...
</span><span class='line'><span class="o">[</span>network http/client/connection/async_normal.ipp:414<span class="o">]</span> connection still active...
</span><span class='line'><span class="o">[</span>network http/client/connection/async_normal.ipp:440<span class="o">]</span> no callback provided, appending to body...
</span><span class='line'><span class="o">[</span>network http/client/connection/normal_delegate.ipp:38<span class="o">]</span> normal_delegate::read_some<span class="o">(</span>...<span class="o">)</span>
</span><span class='line'><span class="o">[</span>network http/client/connection/normal_delegate.ipp:39<span class="o">]</span> scheduling asynchronous <span class="nb">read </span>some...
</span><span class='line'><span class="o">[</span>network http/client/connection/normal_delegate.ipp:41<span class="o">]</span> scheduled asynchronous <span class="nb">read </span>some...
</span><span class='line'><span class="o">[</span>network http/client/connection/async_normal.ipp:237<span class="o">]</span> http_async_connection_pimpl::handle_received_data<span class="o">(</span>...<span class="o">)</span>
</span><span class='line'><span class="o">[</span>network http/client/connection/async_normal.ipp:252<span class="o">]</span> processing data chunk, no error encountered so far...
</span><span class='line'><span class="o">[</span>network http/client/connection/async_normal.ipp:380<span class="o">]</span> parsing body...
</span><span class='line'><span class="o">[</span>network http/client/connection/async_normal.ipp:382<span class="o">]</span> end of the line.
</span><span class='line'><span class="o">[</span>network http/client/connection/async_normal.ipp:399<span class="o">]</span> no callback provided, appending to body...
</span></code></pre></td></tr></table></div></figure>


<p>after which it seemed to pause for a few minutes before printing out the received body.</p>

<p>However, this seemed to depend on the url in question. For example, trying it on a static web page that forms part of this blog, <code>$ time ./hello-world http://agam.github.io/posts/building-boost-clang-gcc.html</code> yielded</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>real    0m10.154s
</span><span class='line'>user    0m0.024s
</span><span class='line'>sys     0m0.004s
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s enough, for me, for now. Maybe I&rsquo;ll try the <a href="http://pocoproject.org/">Poco libraries</a> next and see if they are any better.</p>

      
      
    </div>
  </div>



    </article>
    
    <hr>
    
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2013-08-26T00:00:00+00:00" pubdate data-updated="true">Aug 26<span>th</span>, 2013</time></h5>
          <div class="row-fluid">
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/boost/"><span class="badge">Boost</span></a>
          
          <a href="/blog/categories/c++/"><span class="badge">C++</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2013/08/26/building-boost-clang-gcc/">In which I recall how to build stuff</a></h1>
      <p>It all started when I wanted to &ldquo;relearn&rdquo; C++. I use it everyday, but it&rsquo;s been so long since I first came across it 15 years ago that I&rsquo;ve accumulated tons of bad habits and thought patterns etc, so I wanted to get a &ldquo;beginner&rsquo;s mind&rdquo; feel of it again.</p>

<h2>The initial detour</h2>

<p>Ok, I thought, let&rsquo;s read the <a href="http://www.amazon.com/The-Programming-Language-3rd-Edition/dp/0201889544">4th edition</a> of Bjarne&rsquo;s introduction to C++, and meanwhile also get to know <a href="http://www.boost.org/">Boost</a> with some familiarity.</p>

<p>So I downloaded the <a href="http://sourceforge.net/projects/boost/files/boost/1.54.0/boost_1_54_0.tar.bz2/download">Boost libraries</a> (which took a while), and then tried to build this basic example (from the Boost FAQ)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'><span class="cp">#include &lt;algorithm&gt;</span>
</span><span class='line'><span class="cp">#include &lt;iterator&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="n">using</span> <span class="n">boost</span><span class="o">::</span><span class="n">lambda</span><span class="o">::</span><span class="n">_1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">istream_iterator</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">in</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span>
</span><span class='line'>      <span class="n">in</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">),</span> <span class="n">in</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">_1</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>using Clang</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>clang -std<span class="o">=</span>c++11 -stdlib<span class="o">=</span>libc++ -I/opt/boost/boost_1_54_0 example.cc -o example
</span></code></pre></td></tr></table></div></figure>


<h2>Fork in the road</h2>

<p>No luck</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>/tmp/example-oWquCX.o: In <span class="k">function</span> <span class="sb">`</span>__cxx_global_var_init3<span class="s1">&#39;:</span>
</span><span class='line'><span class="s1">example.cc:(.text+0x71): undefined reference to `std::ios_base::Init::Init()&#39;</span>
</span><span class='line'>example.cc:<span class="o">(</span>.text+0x79<span class="o">)</span>: undefined reference to <span class="sb">`</span>std::ios_base::Init::~Init<span class="o">()</span><span class="s1">&#39;</span>
</span><span class='line'><span class="s1">/tmp/example-oWquCX.o: In function `main&#39;</span>:
</span><span class='line'>example.cc:<span class="o">(</span>.text+0xb3<span class="o">)</span>: undefined reference to <span class="sb">`</span>std::cin<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">example.cc:(.text+0xf0): undefined reference to `std::cout&#39;</span>
</span><span class='line'>/tmp/example-oWquCX.o: In <span class="k">function</span> <span class="sb">`</span>std::istream_iterator&lt;int, char, std::char_traits&lt;char&gt;, long&gt;::_M_read<span class="o">()</span><span class="err">&#39;</span>:
</span></code></pre></td></tr></table></div></figure>


<p>(and more that I&rsquo;ll skip over right now).</p>

<p>Later I realized that this was probably my fault in not linking it correctly, but I immediately, inexplicably, decided &ldquo;Aha! let&rsquo;s build clang from source!&rdquo;</p>

<p>This might also have been because I had gotten bored of <code>sudo apt-get install foo</code> and longed for the (decade ago) days of <code>emerge foo</code>.</p>

<h2>Deep in the woods</h2>

<p>Luckily, this turned out to be <a href="http://solarianprogrammer.com/2013/01/17/building-clang-libcpp-ubuntu-linux/">well-documented</a>, more or less.</p>

<p>So I got up to the point where I got and built <code>clang</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>svn co http://llvm.org/svn/llvm-project/llvm/trunk llvm
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>llvm/tools
</span><span class='line'><span class="nv">$ </span>svn co http://llvm.org/svn/llvm-project/cfe/trunk clang
</span><span class='line'><span class="nv">$ </span>mkdir build <span class="o">&amp;&amp;</span> <span class="nb">cd </span>build
</span><span class='line'><span class="nv">$ </span>../llvm/configure --prefix<span class="o">=</span>/usr/clang_3_3 <span class="se">\</span>
</span><span class='line'>  --enable-optimized --enable-targets<span class="o">=</span>host
</span><span class='line'><span class="nv">$ </span>make -j 8
</span></code></pre></td></tr></table></div></figure>


<p>And I procedded to then build <code>libcxx</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>svn co http://llvm.org/svn/llvm-project/libcxx/trunk libcxx
</span><span class='line'><span class="nv">$ </span>mkdir build_libcxx <span class="o">&amp;&amp;</span> <span class="nb">cd </span>build_libcxx
</span><span class='line'><span class="nv">$ CC</span><span class="o">=</span>clang <span class="nv">CXX</span><span class="o">=</span>clang++ cmake -G <span class="s2">&quot;Unix Makefiles&quot;</span> <span class="se">\</span>
</span><span class='line'>  -DLIBCXX_CXX_ABI<span class="o">=</span>libsupc++ <span class="se">\</span>
</span><span class='line'>  -DLIBCXX_LIBSUPCXX_INCLUDE_PATHS<span class="o">=</span><span class="s2">&quot;/usr/include/c++/4.6/;\</span>
</span><span class='line'><span class="s2">  /usr/include/c++/4.6/x86_64-linux-gnu/&quot;</span> <span class="se">\</span>
</span><span class='line'>  -DCMAKE_BUILD_TYPE<span class="o">=</span>Release -DCMAKE_INSTALL_PREFIX<span class="o">=</span>/usr <span class="nv">$HOME</span>/Clang/libcxx
</span><span class='line'><span class="nv">$ </span>make
</span></code></pre></td></tr></table></div></figure>


<h2>Mt. Doom</h2>

<p>At this point I got a compiler error. Very sad. Too bad, I thought, we need to go deeper. Time for building <code>gcc</code>/<code>g++</code> and a new version of the C++ standard library. My Ubuntu version only had <code>gcc</code> upto <code>4.6</code>, and I found <a href="http://lists.cs.uiuc.edu/pipermail/llvmbugs/2013-February/027116.html">a mailing list post</a> which suggested this might be fixed in <code>4.7</code>.</p>

<p>I could have at this point decided to add a PPA repository and got the new libraries and binaries that way, but luckily this was <a href="http://solarianprogrammer.com/2012/04/13/building-gcc-4-7-on-ubuntu-12-04/">also well-documented</a> (thank you, &ldquo;Solarian Programmer&rdquo;, whoever you are!).</p>

<p>So I went ahead and downloaded <a href="http://www.netgull.com/gcc/releases/gcc-4.7.3/gcc-4.7.3.tar.bz2"><code>gcc</code></a>, and what turned out to be its prerequisites, <a href="ftp://ftp.gmplib.org/pub/gmp-5.1.2/gmp-5.1.2.tar.lz"><code>gmp</code></a>, <a href="http://www.mpfr.org/mpfr-current/mpfr-3.1.2.tar.gz"><code>mpfr</code></a> and <a href="http://www.multiprecision.org/mpc/download/mpc-1.0.tar.gz"><code>mpc</code></a>.</p>

<p>These I built in the usual way (<code>configure</code>, <code>make</code>, <code>make install</code>), and then had to refer to them while setting up <code>gcc</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/usr/gcc_4_7/lib:<span class="nv">$LD_LIBRARY_PATH</span>
</span><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">LIBRARY_PATH</span><span class="o">=</span>/usr/lib/x86_64-linux-gnu/
</span><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">C_INCLUDE_PATH</span><span class="o">=</span>/usr/include/x86_64-linux-gnu
</span><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">CPLUS_INCLUDE_PATH</span><span class="o">=</span>/usr/include/x86_64-linux-gnu
</span><span class='line'><span class="nv">$ </span>../gcc-4.7.2/configure --build<span class="o">=</span>x86_64-linux-gnu --prefix<span class="o">=</span>/usr/gcc_4_7 <span class="se">\</span>
</span><span class='line'>  --with-gmp<span class="o">=</span>/usr/gcc_4_7 --with-mpfr<span class="o">=</span>/usr/gcc_4_7 <span class="se">\</span>
</span><span class='line'>  --with-mpc<span class="o">=</span>/usr/gcc_4_7 --enable-checking<span class="o">=</span>release <span class="se">\</span>
</span><span class='line'>  --enable-languages<span class="o">=</span>c,c++,fortran --disable-multilib <span class="se">\</span>
</span><span class='line'>  --program-suffix<span class="o">=</span>-4.7
</span></code></pre></td></tr></table></div></figure>


<p>Now I could proceed where I left off earlier, with the <code>libcxx</code> build, after setting a couple of path variables:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/usr/gcc_4_7/bin:<span class="nv">$PATH</span>
</span><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/usr/gcc_4_7/lib:/usr/gcc_4_7/lib64:<span class="nv">$LD_LIBRARY_PATH</span>
</span></code></pre></td></tr></table></div></figure>


<h2>A ray of hope</h2>

<p>But first, I wanted to see if the new <code>g++</code> could do what I had initially tried to do with <code>clang</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>g++4.7 -std<span class="o">=</span>c++11 -I/opt/boost/boost_1_54_0 example.cc -o example
</span><span class='line'><span class="nv">$ </span><span class="nb">echo </span>1 2 3 | ./example
</span><span class='line'>3 6 9
</span></code></pre></td></tr></table></div></figure>


<p>Whew, now I was getting somewhere.</p>

<p>I went back and re-ran <code>cmake</code>, and then <code>libcxx</code> built successfully.</p>

<p>And then of course, I retried my original example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>/usr/clang_3_3/bin/clang++ -std<span class="o">=</span>c++11 -I/opt/boost/boost_1_54_0 example.cc -o example
</span></code></pre></td></tr></table></div></figure>


<p>and that worked too &hellip; Woohoo!!</p>

<p>Finally, since I always measure running time:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span><span class="nb">time</span> /usr/clang_3_3/bin/clang++ -std<span class="o">=</span>c++11 -I/opt/boost/boost_1_54_0 example.cc -o example
</span><span class='line'>
</span><span class='line'>real    0m0.848s
</span><span class='line'>user    0m0.780s
</span><span class='line'>sys     0m0.056s
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span><span class="nb">time </span>g++4.7 -std<span class="o">=</span>c++11 -I/opt/boost/boost_1_54_0 example.cc -o example
</span><span class='line'>
</span><span class='line'>real    0m0.714s
</span><span class='line'>user    0m0.648s
</span><span class='line'>sys     0m0.044s
</span></code></pre></td></tr></table></div></figure>


<p>Now to do something more than this example program &hellip;</p>

      
      
    </div>
  </div>



    </article>
    
    <hr>
    
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2013-08-14T00:00:00+00:00" pubdate data-updated="true">Aug 14<span>th</span>, 2013</time></h5>
          <div class="row-fluid">
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/desktop/"><span class="badge">Desktop</span></a>
          
          <a href="/blog/categories/kde/"><span class="badge">KDE</span></a>
          
          <a href="/blog/categories/linux/"><span class="badge">Linux</span></a>
          
          <a href="/blog/categories/xmonad/"><span class="badge">XMonad</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2013/08/14/switching-to-kde/">Switching to KDE</a></h1>
      <p>I have been using <a href="http://xmonad.org/">Xmonad</a> for almost a couple of years, mostly because I wanted a tiling window manager that would maximize screen space and allow fast window and desktop switching on my linux laptop.</p>

<p>Recently, I decided to go back to a full-fledged desktop environment again, and I (randomly (please, no &ldquo;Gnome vs Kde&rdquo; flamewar)) picked KDE. The last time I used it was maybe 8 years ago (!), and I was eager to see what I had been missing.</p>

<p>It seems to have gotten better in the same sense that all linux software has gotten better in the last several years (and the machine I&rsquo;m running it on has gotten much faster too!), but I particularly liked the idea of <a href="http://userbase.kde.org/Plasma#Activities">Activities</a>, being somewhat orthogonal to the idea of multiple desktops, and I found it useful to add &ldquo;work&rdquo;, &ldquo;browsing&rdquo;, &ldquo;writing&rdquo; etc areas.</p>

<h2>Minor tweaks</h2>

<p>I had to change the screen rotation of one of my monitors at my desktop, but this was fairly straightforward: [System Settings] &ndash;> [Display &amp; Monitor] &ndash;> [Size &amp; Orientation]</p>

<p>I also always get rid of the useless Caps Lock: [System Settings] &ndash;> [Input Devices] &ndash;> [Keyboard]</p>

<p>There&rsquo;s one issue which I&rsquo;m not quite sure about &mdash; I encountered a <code>no d-bus daemon running</code> message, which I fixed by <code>export $(dbus-launch)</code>, and I haven&rsquo;t encountered it since, but I haven&rsquo;t read up enough to know if this requires some more setup.</p>

<p>I had an <code>xscreensaver</code> lock alias earlier, and I wanted something similar; I assigned <code>klock</code> to <code>/usr/lib/kde4/libexec/kscreenlocker --forcelock</code></p>

<p>Finally, I need a way to setup easy terminal access. I setup <code>Meta+T</code> to run <code>konsole</code>, <code>Meta+R</code> to run <code>krunner</code> (which brings up a &ldquo;quick run&rdquo; box), and (I love this part) installed <code>yakuake</code> which I mapped to <code>Meta+`</code>.</p>

<h2>Other switches considered: Firefox</h2>

<p>I tried moving to Firefox for a while, but I really found it slower than Google Chrome. OK, I didn&rsquo;t personally benchmark it, but several content-heavy websites seemed to load slower.</p>

<p>Also, I had gotten used to certain workflows in Chrome (such as entering <code>amazon.com</code>, hitting <code>Tab</code> and then typing what I wanted to search within Amazon) which were no longer possible with Firefox, and I didn&rsquo;t want to take the productivity hit.</p>

<p>However, I installed the Android app, and activated Firefox Sync and everything worked pretty well. Honestly, I liked the mobile app better. But this is one of those all or nothing switches, since the &ldquo;tab syncing&rdquo; between desktop/laptop/mobile browsers is indispensable to me.</p>

<p>I will definitely consider this in the future again, especially if Firefox&rsquo;s rendering speed improves w.r.t. Chrome.</p>

<h2>Other switches considered: Emacs</h2>

<p>This is one of those eternal conflicts, as I mentioned in <a href="/blog/2013/08/06/slimv/">a previous post</a>. I keep wanting to switch to Emacs, but Vim always remains atleast an order of magnitude faster for me, for most common tasks, so I just can&rsquo;t do it.</p>

<p>As I see it, nothing which begins with <code>C-u</code> can ever be faster than the equivalent two-character command in Vim (in particular, <code>C-x z</code> is 10 times slower than just <code>.</code>).</p>

<p>Recently, I was discussing this with a few colleagues, and one of the things that was suggested was <code>Viper</code>-mode in Emacs as a halfway compromise.</p>

<p>I&rsquo;ll look into it, see what keystrokes are supported, and if my regular workflow is unaffected, this too might be a switch I&rsquo;d be willing to make in the future.</p>

<p><em><strong>Update</strong></em>: I have since switched from the linux laptop I was doing this on,
to a Chromebook, making the discussion somewhat moot now. However, I am still
using KDE on a desktop environment and loving it.</p>

      
      
    </div>
  </div>



    </article>
    
    <hr>
    
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2013-08-06T00:00:00+00:00" pubdate data-updated="true">Aug 6<span>th</span>, 2013</time></h5>
          <div class="row-fluid">
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/vim/"><span class="badge">Vim</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2013/08/06/slimv/">SlimV and Vim (as an equivalent to Emacs and Slime)</a></h1>
      <p>I&rsquo;ve switched between Emacs and Vim a few times over the last 15-odd years, before finally (?) settling on Vim. I&rsquo;ve come to the realization, as many have before me, that for all the elegant awesomeness of Emacs Lisp,</p>

<blockquote><p>Vim is a better <em>text</em> editor, Emacs is good for everything else</p></blockquote>

<p>Perhaps one day if <a href="http://www.gnu.org/software/guile/">Guile</a> or <a href="https://google-melange.appspot.com/gsoc/proposal/review/google/gsoc2013/shanecelis/1">Emacsey</a> deliver their full promise, I&rsquo;ll happily live inside a REPL forever.</p>

<p>Until then, it&rsquo;s just <em>much, much, much</em> faster to do the equivalent <em>text</em> operations in Vim than in Emacs (yes, I mapped CapsLock to Control; yes, I replaced <code>M-</code> by <code>C-xC-m-</code>).</p>

<p>There were still a few Emacs-only things that haunted me (I outgrew the need to have a <a href="http://emacs-w3m.namazu.org/">web browser</a> or an <a href="http://www.gnu.org/software/emacs/manual/html_mono/erc.html">IRC client</a> in my editor environment, I now use Google Chrome for the former and BitchX/Irssi/Xchat for the latter. I also don&rsquo;t mind reading my <a href="http://gmail.com">email</a> in the browser), such as <a href="http://orgmode.org/"><code>org-mode</code></a>. Fortunately for me, I don&rsquo;t most of its features, and keeping a timestamped diary is something I was able to fix for myself with some shell scripting and vim shortcuts.</p>

<p>Recently, I decided to learn Common Lisp with as much of a newbie attitude as possible. And here I ran into a veritable wall of convention. <em>Of course, didn&rsquo;t I know, that Emacs + Slime is the one true way ?</em>
<em><strong>Update</strong></em>: Uh no, I take back that decision (why? maybe a future post to
answer that question)</p>

<p>I dithered, was flustered and nearly reconsidered.</p>

<p>And then I discovered the awesomeness I was looking for, a replacement for Slime in Vim, <a href="http://www.vim.org/scripts/script.php?script_id=2531">Slimv</a>!</p>

<p><a href="http://kovisoft.bitbucket.org/tutorial.html">Here is a tutorial</a> to get you started, but basically all I had to do was to install the plugin and the rest pretty much <em>just worked</em>.</p>

<p>There are quite a lot of nifty tricks here, but my most frequently used commands are:</p>

<ul>
<li><code>,L</code>: that&rsquo;s a comma followed by L): compile current file</li>
<li><code>,D</code>: compile current form</li>
<li><code>,s</code>: lookup a short summary description of the keyword under the cursor</li>
<li><code>,c</code>: Open Slimv session (splits the window horizontally)</li>
</ul>


<p>I was also new to <code>paredit mode</code>, which is pretty much necessary for making changes to heavily nested parantheses, and it has useful commands there too:</p>

<ul>
<li><code>,W</code>: wrap an extra set of parentheses around the current form</li>
<li><code>,S</code>: it&rsquo;s opposite; remove <em>one</em> set of parentheses from the current form</li>
<li><code>,&lt;</code>, <code>,&gt;</code>: move the parentheses under the cursor one form to the left or right</li>
</ul>


<p>&hellip; and much more. So next time someone tells you how <code>Slime</code> is indispensable and hence Emacs is indispensable, throw <code>Slimv</code> in their face! Kudos to <a href="http://www.vim.org/account/profile.php?user_id=16470">the guy who built it</a>!</p>

      
      
    </div>
  </div>



    </article>
    
    <hr>
    
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2013-07-24T00:00:00+00:00" pubdate data-updated="true">Jul 24<span>th</span>, 2013</time></h5>
          <div class="row-fluid">
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/commandline/"><span class="badge">CommandLine</span></a>
          
          <a href="/blog/categories/notes/"><span class="badge">Notes</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2013/07/24/rudimentary-command-line-note-taking/">Rudimentary note taking on the command line</a></h1>
      <p>Everyone has their own pet setup; here&rsquo;s mine. Its just a bunch of text files, shared on Dropbox.</p>

<p>I have a bash alias to make a directory if required, create the file, and open it in Vim.</p>

<p>Within the file, I use markdown for text, and a few additional conventions to make it easier to search through them.</p>

<p>I use one file per date, with the name being something like <code>~/notes/2013/07/24</code>.</p>

<p>The following one-liner in my <code>.bashrc</code> accomplishes this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># Bring up the day&#39;s notes</span>
</span><span class='line'><span class="k">function </span>diary<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">year</span><span class="o">=</span><span class="sb">`</span>date <span class="s2">&quot;+%Y&quot;</span><span class="sb">`</span>
</span><span class='line'>  <span class="nv">month</span><span class="o">=</span><span class="sb">`</span>date <span class="s2">&quot;+%m&quot;</span><span class="sb">`</span>
</span><span class='line'>  <span class="nv">day</span><span class="o">=</span><span class="sb">`</span>date <span class="s2">&quot;+%d&quot;</span><span class="sb">`</span>
</span><span class='line'>  <span class="nv">diarydir</span><span class="o">=</span>~/Dropbox/personalnotes/<span class="nv">$year</span>/<span class="nv">$month</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">[[</span> ! -d <span class="s2">&quot;$diarydir&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">    </span>mkdir -p <span class="s2">&quot;$diarydir&quot;</span>
</span><span class='line'>  <span class="k">fi</span>
</span><span class='line'><span class="k">  </span>vi <span class="nv">$diarydir</span>/<span class="nv">$day</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I also use some additional <em>metadata</em> within it, such as adding &lsquo;@14:45&rsquo; to indicate a timestamp before a paragraph, and &lsquo;#category&rsquo; to mark off sections (I use &lsquo;##category&rsquo; to denote one-line or one paragraph sections, otherwise all text is assumed to belong to the last declared section).</p>

<p>For convenience, I defined the following mapping in my <code>.vimrc</code> that inserts the timestamp when required:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>nmap &lt;C-c&gt;&lt;C-t&gt; o@&lt;C-R&gt;<span class="o">=</span>strftime<span class="o">(</span><span class="s2">&quot;%H:%M&quot;</span><span class="o">)</span>&lt;CR&gt;&lt;CR&gt;&lt;CR&gt;
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ll cover the retrieval part of this in a separate post. If you don&rsquo;t have any note taking system yet, and don&rsquo;t want to go to the extent of <em>blogging</em> every little thing you want to note down, and find it a bit of a hassle to open up Evernote or something similar to jot something down, you might like to try this quick and simple text-based solution!</p>

      
      
    </div>
  </div>



    </article>
    
    <hr>
    
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2013-06-26T00:00:00+00:00" pubdate data-updated="true">Jun 26<span>th</span>, 2013</time></h5>
          <div class="row-fluid">
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/c++/"><span class="badge">C++</span></a>
          
          <a href="/blog/categories/haskell/"><span class="badge">Haskell</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2013/06/26/data-structures-haskell-vs-cpp/">Comparison of data structures in C++ and Haskell</a></h1>
      <p>Once again, just to satisfy my curiosity, I want to do a tiny comparison of a basic feature in both languages, trying to see how data structures are implemented. Ok, I&rsquo;m fairly certain how it works for in C++, I&rsquo;m really just curious about Haskell.</p>

<h2>C++ version</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'><span class="cp">#include &lt;memory&gt;</span>
</span><span class='line'><span class="cp">#include &lt;vector&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">BinaryNode</span> <span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
</span><span class='line'>  <span class="n">BinaryNode</span> <span class="o">*</span><span class="n">leftchild</span><span class="p">,</span> <span class="o">*</span><span class="n">rightchild</span><span class="p">;</span>
</span><span class='line'>  <span class="n">BinaryNode</span><span class="p">(</span><span class="kt">int</span> <span class="n">v</span><span class="p">,</span> <span class="n">BinaryNode</span><span class="o">*</span> <span class="n">lc</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">,</span> <span class="n">BinaryNode</span><span class="o">*</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">)</span>
</span><span class='line'>    <span class="o">:</span> <span class="n">val</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">leftchild</span><span class="p">(</span><span class="n">lc</span><span class="p">),</span> <span class="n">rightchild</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">NaryNode</span> <span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">NaryNode</span><span class="o">*&gt;</span> <span class="n">children</span><span class="p">;</span>
</span><span class='line'>  <span class="n">NaryNode</span><span class="p">(</span><span class="kt">int</span> <span class="n">v</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">NaryNode</span><span class="o">*&gt;&amp;</span> <span class="n">c</span><span class="p">)</span> <span class="o">:</span> <span class="n">val</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">children</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">binarySum</span><span class="p">(</span><span class="n">BinaryNode</span><span class="o">*</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="n">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">+</span> <span class="n">binarySum</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">leftchild</span><span class="p">)</span> <span class="o">+</span> <span class="n">binarySum</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">rightchild</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">narySum</span><span class="p">(</span><span class="n">NaryNode</span><span class="o">*</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="n">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="n">it</span> <span class="o">:</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">sum</span> <span class="o">+=</span> <span class="n">narySum</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">sum</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create dummy binary and n-ary trees and print out their sum</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">BinaryNode</span><span class="o">&gt;</span> <span class="n">bnode1</span><span class="p">(</span><span class="n">new</span> <span class="n">BinaryNode</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">BinaryNode</span><span class="o">&gt;</span> <span class="n">bnode2</span><span class="p">(</span><span class="n">new</span> <span class="n">BinaryNode</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">BinaryNode</span><span class="o">&gt;</span> <span class="n">broot</span><span class="p">(</span><span class="n">new</span> <span class="n">BinaryNode</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bnode1</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">bnode2</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;BinarySum = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">binarySum</span><span class="p">(</span><span class="n">broot</span><span class="p">.</span><span class="n">get</span><span class="p">())</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">NaryNode</span><span class="o">*&gt;</span> <span class="n">children</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">NaryNode</span><span class="o">&gt;</span> <span class="n">nnode1</span><span class="p">(</span><span class="n">new</span> <span class="n">NaryNode</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">children</span><span class="p">));</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">NaryNode</span><span class="o">&gt;</span> <span class="n">nnode2</span><span class="p">(</span><span class="n">new</span> <span class="n">NaryNode</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">children</span><span class="p">));</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">NaryNode</span><span class="o">&gt;</span> <span class="n">nnode3</span><span class="p">(</span><span class="n">new</span> <span class="n">NaryNode</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">children</span><span class="p">));</span>
</span><span class='line'>  <span class="n">children</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">nnode1</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span><span class='line'>  <span class="n">children</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">nnode2</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span><span class='line'>  <span class="n">children</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">nnode3</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">NaryNode</span><span class="o">&gt;</span> <span class="n">nroot</span><span class="p">(</span><span class="n">new</span> <span class="n">NaryNode</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">children</span><span class="p">));</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;NarySum = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">narySum</span><span class="p">(</span><span class="n">nroot</span><span class="p">.</span><span class="n">get</span><span class="p">())</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Assembly highlights:</p>

<p>Uploaded the full file as a <a href="https://gist.github.com/agam/5872178">Gist</a> (it&rsquo;s 6437 lines long, we aren&rsquo;t in <em>Hello World</em> territory any more; on the other hand, this program would have been much longer in C.</p>

<p>The function <code>_Z9binarySumP10BinaryNode</code> is defined near the top, and the function <code>_Z7narySumP8NaryNode</code> right under it.</p>

<p>The assembly code follows along almost exactly as the C++ code above (of course all the struct offsets are &ldquo;just added&rdquo; and you don&rsquo;t see the members being accessed directly).</p>

<p>The recursion is more obviously visible for the first function, where you see a pattern of &ldquo;call the function&rdquo;, &ldquo;call the function again&rdquo; and then add the node value to it. For the second function, you can see calls to <code>vector&lt;NaryNode&gt;::begin()</code> and <code>vector&lt;NaryNode&gt;::end()</code> at the beginning of the loop, and the test &lsquo;n&rsquo; jump and the recursive call in the middle of the body.</p>

<p>It is useful also to see how <code>main()</code> works here, you can see three calls to the <code>BinaryNode</code> constructor (<code>_ZN10BinaryNodeC1EiPS_S0_</code>), and then similar stuff for the <code>NaryNode</code> objects. At the end are multiple calls to the destructors (similar to <code>callq _ZNSt10unique_ptrI8NaryNodeSt14default_deleteIS0_EED1Ev</code>).</p>

<p>Most of the rest of the code is the definition of these functions (vector begin/end and unique_ptr delete etc.)</p>

<p>Note: I found a better way to show the assembly &lt;&ndash;> source correspondence, in an interactive way: <a href="http://gcc.godbolt.org/">GCC Explorer</a> and I&rsquo;ll use that next time, it&rsquo;s just way more convenient. Also, I&rsquo;ve been showing unoptimized assembly, which is <em>just noise</em>, will refer to <code>-O2</code> next time.</p>

<h2>Haskell version</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="kr">data</span> <span class="kt">BinaryTree</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">BinaryLeaf</span> <span class="n">a</span> <span class="o">|</span> <span class="kt">BinaryBranch</span> <span class="p">(</span><span class="kt">BinaryTree</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="kt">BinaryTree</span> <span class="n">a</span><span class="p">)</span>
</span><span class='line'><span class="kr">data</span> <span class="kt">NaryTree</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">NaryLeaf</span> <span class="n">a</span> <span class="o">|</span> <span class="kt">NaryBranch</span> <span class="p">[</span><span class="kt">NaryTree</span> <span class="n">a</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="nf">binarySum</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Num</span> <span class="n">a</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="p">(</span><span class="kt">BinaryTree</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">a</span>
</span><span class='line'><span class="nf">binarySum</span> <span class="p">(</span><span class="kt">BinaryLeaf</span> <span class="n">x</span><span class="p">)</span> <span class="ow">=</span> <span class="n">x</span>
</span><span class='line'><span class="nf">binarySum</span> <span class="p">(</span><span class="kt">BinaryBranch</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span> <span class="ow">=</span>  <span class="p">(</span><span class="n">binarySum</span> <span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">binarySum</span> <span class="n">b</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nf">narySum</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Num</span> <span class="n">a</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">NaryTree</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span>
</span><span class='line'><span class="nf">narySum</span> <span class="p">(</span><span class="kt">NaryLeaf</span> <span class="n">x</span><span class="p">)</span> <span class="ow">=</span> <span class="n">x</span>
</span><span class='line'><span class="nf">narySum</span> <span class="p">(</span><span class="kt">NaryBranch</span> <span class="n">b</span><span class="p">)</span> <span class="ow">=</span> <span class="n">foldl</span> <span class="p">(</span><span class="nf">\</span><span class="n">acc</span> <span class="n">x</span> <span class="ow">-&gt;</span> <span class="n">acc</span> <span class="o">+</span> <span class="p">(</span><span class="n">narySum</span> <span class="n">x</span><span class="p">))</span> <span class="mi">0</span> <span class="n">b</span>
</span><span class='line'>
</span><span class='line'><span class="c1">--Create dummy binary and n-ary trees and print out their sum</span>
</span><span class='line'><span class="nf">main</span> <span class="ow">=</span> <span class="kr">let</span> <span class="n">bt</span> <span class="ow">=</span> <span class="kt">BinaryBranch</span> <span class="p">(</span><span class="kt">BinaryLeaf</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="kt">BinaryLeaf</span> <span class="mi">5</span><span class="p">)</span>
</span><span class='line'>           <span class="n">nt</span> <span class="ow">=</span> <span class="kt">NaryBranch</span> <span class="p">((</span><span class="kt">NaryLeaf</span> <span class="mi">4</span><span class="p">)</span> <span class="kt">:</span> <span class="p">(</span><span class="kt">NaryLeaf</span> <span class="mi">5</span><span class="p">)</span> <span class="kt">:</span> <span class="p">(</span><span class="kt">NaryLeaf</span> <span class="mi">6</span><span class="p">)</span> <span class="kt">:</span> <span class="kt">[]</span><span class="p">)</span>
</span><span class='line'>       <span class="kr">in</span> <span class="kr">do</span>
</span><span class='line'>          <span class="n">putStrLn</span> <span class="p">(</span><span class="s">&quot;BinarySum = &quot;</span> <span class="o">++</span> <span class="n">show</span><span class="p">(</span><span class="n">binarySum</span> <span class="n">bt</span><span class="p">))</span>
</span><span class='line'>          <span class="n">putStrLn</span> <span class="p">(</span><span class="s">&quot;NarySum = &quot;</span> <span class="o">++</span> <span class="n">show</span><span class="p">(</span><span class="n">narySum</span> <span class="n">nt</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Assembly highlights:</p>

<p>Uploaded the <a href="https://gist.github.com/agam/5974455">full file (core) as a Gist</a></p>

<p><code>main</code> is present as <code>main1</code> near the bottom, which has two calls to <code>Handle.Text.hPutStr2</code></p>

<p>The binary sum is unpacked quite straightforwardly :&ndash;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="nf">main_</span><span class="o">$</span><span class="n">sbinarySum</span> <span class="ow">=</span>
</span><span class='line'>  <span class="nf">\</span> <span class="p">(</span><span class="n">ds_dBk</span> <span class="ow">::</span> <span class="kt">BinaryTree</span> <span class="kt">Type</span><span class="o">.</span><span class="kt">Integer</span><span class="p">)</span> <span class="ow">-&gt;</span>
</span><span class='line'>    <span class="kr">case</span> <span class="n">ds_dBk</span> <span class="kr">of</span> <span class="kr">_</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">BinaryLeaf</span> <span class="n">x_aaA</span> <span class="ow">-&gt;</span> <span class="n">x_aaA</span><span class="p">;</span>
</span><span class='line'>      <span class="kt">BinaryBranch</span> <span class="n">a_aaB</span> <span class="n">b_aaC</span> <span class="ow">-&gt;</span>
</span><span class='line'>        <span class="kt">Type</span><span class="o">.</span><span class="n">plusInteger</span>
</span><span class='line'>          <span class="p">(</span><span class="n">main_</span><span class="o">$</span><span class="n">sbinarySum</span> <span class="n">a_aaB</span><span class="p">)</span> <span class="p">(</span><span class="n">main_</span><span class="o">$</span><span class="n">sbinarySum</span> <span class="n">b_aaC</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>whereas the nary sum is less so :&ndash;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="nf">main_</span><span class="o">$</span><span class="n">snarySum</span> <span class="ow">=</span>
</span><span class='line'>  <span class="nf">\</span> <span class="p">(</span><span class="n">ds_dtA</span> <span class="ow">::</span> <span class="kt">NaryTree</span> <span class="kt">Type</span><span class="o">.</span><span class="kt">Integer</span><span class="p">)</span> <span class="ow">-&gt;</span>
</span><span class='line'>    <span class="kr">case</span> <span class="n">ds_dtA</span> <span class="kr">of</span> <span class="kr">_</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">NaryLeaf</span> <span class="n">x_aad</span> <span class="ow">-&gt;</span> <span class="n">x_aad</span><span class="p">;</span>
</span><span class='line'>      <span class="kt">NaryBranch</span> <span class="n">b_aae</span> <span class="ow">-&gt;</span> <span class="n">lgo_r1MR</span> <span class="n">lvl_r1MQ</span> <span class="n">b_aae</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nf">lgo_r1MR</span> <span class="ow">=</span>
</span><span class='line'>  <span class="nf">\</span> <span class="p">(</span><span class="n">z_atM</span> <span class="ow">::</span> <span class="kt">Type</span><span class="o">.</span><span class="kt">Integer</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="n">ds_atN</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">NaryTree</span> <span class="kt">Type</span><span class="o">.</span><span class="kt">Integer</span><span class="p">])</span> <span class="ow">-&gt;</span>
</span><span class='line'>    <span class="kr">case</span> <span class="n">ds_atN</span> <span class="kr">of</span> <span class="kr">_</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">[]</span> <span class="ow">-&gt;</span> <span class="n">z_atM</span><span class="p">;</span>
</span><span class='line'>      <span class="kt">:</span> <span class="n">x_atS</span> <span class="n">xs_atT</span> <span class="ow">-&gt;</span>
</span><span class='line'>        <span class="n">lgo_r1MR</span>
</span><span class='line'>          <span class="p">(</span><span class="kt">Type</span><span class="o">.</span><span class="n">plusInteger</span> <span class="n">z_atM</span> <span class="p">(</span><span class="n">main_</span><span class="o">$</span><span class="n">snarySum</span> <span class="n">x_atS</span><span class="p">))</span>
</span><span class='line'>          <span class="n">xs_atT</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>with the second function being defined for iteration. I uploaded a gist with the <a href="https://gist.github.com/agam/5974501">assembly output</a>, which is of course tedious and quite spaghetti-like.</p>

<p>Here is an example of the nary leaf:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='nasm'><span class='line'><span class="nf">.globl</span> <span class="nv">Main_NaryLeaf_closure</span>
</span><span class='line'><span class="nf">.type</span> <span class="nv">Main_NaryLeaf_closure</span><span class="p">,</span> <span class="err">@</span><span class="nv">object</span>
</span><span class='line'><span class="nl">Main_NaryLeaf_closure:</span>
</span><span class='line'>  <span class="nf">.quad</span>   <span class="nv">Main_NaryLeaf_info</span>
</span><span class='line'><span class="nf">.text</span>
</span><span class='line'>  <span class="nf">.align</span> <span class="mi">8</span>
</span><span class='line'>  <span class="nf">.quad</span>   <span class="mi">4294967301</span>
</span><span class='line'>  <span class="nf">.quad</span>   <span class="mi">0</span>
</span><span class='line'>  <span class="nf">.quad</span>   <span class="mi">15</span>
</span><span class='line'><span class="nl">Main_NaryLeaf_info:</span>
</span><span class='line'><span class="nl">.LcBb:</span>
</span><span class='line'>  <span class="nf">addq</span> <span class="kc">$</span><span class="mi">16</span><span class="p">,</span><span class="o">%</span><span class="nv">r12</span>
</span><span class='line'>  <span class="nf">cmpq</span> <span class="mi">144</span><span class="p">(</span><span class="o">%</span><span class="nv">r13</span><span class="p">),</span><span class="o">%</span><span class="nv">r12</span>
</span><span class='line'>  <span class="nf">ja</span> <span class="nv">.LcBg</span>
</span><span class='line'>  <span class="nf">movq</span> <span class="kc">$</span><span class="nv">Main_NaryLeaf_con_info</span><span class="p">,</span><span class="o">-</span><span class="mi">8</span><span class="p">(</span><span class="o">%</span><span class="nv">r12</span><span class="p">)</span>
</span><span class='line'>  <span class="nf">movq</span> <span class="o">%</span><span class="nv">r14</span><span class="p">,</span><span class="mi">0</span><span class="p">(</span><span class="o">%</span><span class="nv">r12</span><span class="p">)</span>
</span><span class='line'>  <span class="nf">leaq</span> <span class="o">-</span><span class="mi">7</span><span class="p">(</span><span class="o">%</span><span class="nv">r12</span><span class="p">),</span><span class="o">%</span><span class="nb">rbx</span>
</span><span class='line'>  <span class="nf">jmp</span> <span class="o">*</span><span class="mi">0</span><span class="p">(</span><span class="o">%</span><span class="nb">rbp</span><span class="p">)</span>
</span><span class='line'><span class="nl">.LcBg:</span>
</span><span class='line'>  <span class="nf">movq</span> <span class="kc">$</span><span class="mi">16</span><span class="p">,</span><span class="mi">192</span><span class="p">(</span><span class="o">%</span><span class="nv">r13</span><span class="p">)</span>
</span><span class='line'><span class="nl">.LcBe:</span>
</span><span class='line'>  <span class="nf">movl</span> <span class="kc">$</span><span class="nv">Main_NaryLeaf_closure</span><span class="p">,</span><span class="o">%</span><span class="nb">ebx</span>
</span><span class='line'>  <span class="nf">jmp</span> <span class="o">*-</span><span class="mi">8</span><span class="p">(</span><span class="o">%</span><span class="nv">r13</span><span class="p">)</span>
</span><span class='line'>  <span class="nf">.size</span> <span class="nv">Main_NaryLeaf_info</span><span class="p">,</span> <span class="nv">.</span><span class="o">-</span><span class="nv">Main_NaryLeaf_info</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Running time</h2>

<p>Pretty much on par here:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span><span class="nb">time</span> ./cpptree
</span><span class='line'><span class="nv">BinarySum</span> <span class="o">=</span> 9
</span><span class='line'><span class="nv">NarySum</span> <span class="o">=</span> 15
</span><span class='line'>
</span><span class='line'>real  0m0.005s
</span><span class='line'>user  0m0.000s
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span><span class="nb">time</span> ./haskelltree
</span><span class='line'><span class="nv">BinarySum</span> <span class="o">=</span> 9
</span><span class='line'><span class="nv">NarySum</span> <span class="o">=</span> 15
</span><span class='line'>
</span><span class='line'>real  0m0.004s
</span><span class='line'>user  0m0.000s
</span><span class='line'>sys   0m0.000s
</span></code></pre></td></tr></table></div></figure>


<p>Fast compilation, comparable run-time, shorter code &hellip; we&rsquo;re talking serious competition here :)</p>

      
      
    </div>
  </div>



    </article>
    
    <hr>
    
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2013-06-23T00:00:00+00:00" pubdate data-updated="true">Jun 23<span>rd</span>, 2013</time></h5>
          <div class="row-fluid">
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/clang/"><span class="badge">Clang</span></a>
          
          <a href="/blog/categories/compiler/"><span class="badge">Compiler</span></a>
          
          <a href="/blog/categories/gcc/"><span class="badge">Gcc</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2013/06/23/clang-vs-gcc-which-would-you-use/">Clang vs Gcc, which would you use?</a></h1>
      <p>Compare these two runs &hellip;</p>

<h2>Clang Error</h2>

<p><img src="/images/clang-error.png" alt="Clang Error highlights source text and is color-coded and formatted to show the location of the actual error, along with actionable suggestions" /></p>

<h2>G++ Error</h2>

<p><img src="/images/gcc-error.png" alt="G++ Error is not color-coded, not formatted, and the actual error is obscured with language lawyer suggestions" /></p>

<p>&hellip; <em>Enough said, hopefully.</em></p>

      
      
    </div>
  </div>



    </article>
    
    <hr>
    
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2013-06-22T00:00:00+00:00" pubdate data-updated="true">Jun 22<span>nd</span>, 2013</time></h5>
          <div class="row-fluid">
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/appengine/"><span class="badge">Appengine</span></a>
          
          <a href="/blog/categories/go/"><span class="badge">Go</span></a>
          
          <a href="/blog/categories/python/"><span class="badge">Python</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2013/06/22/python-to-go/">Appengine transition from Python to Go</a></h1>
      <p>Hadn&rsquo;t updated this blog for a few months, and neither the &ldquo;personal web site&rdquo; that I had started earlier. So, to try something new, I decided to port that appengine site from python to go (looking at the Github logs, I haven&rsquo;t updated that for 2 years !!)</p>

<p>The <code>app.yaml</code> is changed to get rid of all non-static handlers (which are now declared inside the <code>func init()</code> in the <code>.go</code> file. So the only handlers will be <code>/static</code>, <code>/robots.txt</code>, and <code>/.*</code>.</p>

<p>Both the <a href="https://developers.google.com/appengine/docs/go/">Appengine docs</a> as well as <a href="http://cuddle.googlecode.com/hg/talk/index.html">a couple</a> <a href="http://jan.newmarch.name/go/chinese/chapter-chinese.html">of examples</a> have basic bootstrapping information.</p>

<p>The first thing I did was to make a barebones &ldquo;Hello World&rdquo; index handler, and run it with</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>google_appengine/dev_appserver.py &lt;path to my app&gt;
</span></code></pre></td></tr></table></div></figure>


<p>But I immediately got this error:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>google.appengine.tools.devappserver2.wsgi_server.BindError: Unable to find a consistent port localhost
</span><span class='line'>Exception in thread Thread-4 <span class="o">(</span>most likely raised during interpreter shutdown<span class="o">)</span>:
</span><span class='line'>Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
</span><span class='line'>  File <span class="s2">&quot;/usr/lib/python2.7/threading.py&quot;</span>, line 551, in __bootstrap_inner
</span><span class='line'>  File <span class="s2">&quot;/usr/lib/python2.7/threading.py&quot;</span>, line 504, in run
</span><span class='line'>  File <span class="s2">&quot;/home/agam/Documents/Code/google_appengine/google/appengine/api/taskqueue/taskqueue_stub.py&quot;</span>, line 2014, in MainLoop
</span><span class='line'>  File <span class="s2">&quot;/home/agam/Documents/Code/google_appengine/google/appengine/api/taskqueue/taskqueue_stub.py&quot;</span>, line 2006, in _Wait
</span><span class='line'>  File <span class="s2">&quot;/usr/lib/python2.7/threading.py&quot;</span>, line 403, in <span class="nb">wait</span>
</span><span class='line'><span class="nb">  </span>File <span class="s2">&quot;/usr/lib/python2.7/threading.py&quot;</span>, line 258, in <span class="nb">wait</span>
</span><span class='line'>&lt;<span class="nb">type</span> <span class="s1">&#39;exceptions.TypeError&#39;</span>&gt;: <span class="s1">&#39;NoneType&#39;</span> object is not callable
</span></code></pre></td></tr></table></div></figure>


<p>After some Googling and Stackoverflowing, I found a somewhat bizarre fix (to use <code>--api_port</code> argument) with the root cause identified as being duplicate <code>localhost</code> mappings in the <code>/etc/hosts</code> file, including ipv6 mappings to localhost. Now I don&rsquo;t want to mess up my <code>/etc/hosts</code> with what is certainly a <em>bad idea</em>, so I used the <code>--api_port</code> option and I saw the &lsquo;hello world&rsquo;. So far, so good.</p>

<p>I had terrible fonts from long ago, and since Google Web Fonts has become pretty awesome since then, headed on over to pick a few custom fonts. Also realized that I really just need to keep the index page, since the custom blog that I started is really superseded by this one and the posterous feed tracker was obsolete some time ago.</p>

<p>The handler idea is quite straightforward, and there is definitely less boilerplate than what <code>index.py</code> was using earlier.</p>

<p>Initial stupid error: All requests were going to the same handler (including static css ones). Had to change url order in <code>app.yaml</code> to move the <code>/static</code> above the <code>/.*</code>.</p>

<p>Ok, all set, the barebones appengine site is up and running, I hope I can add some fun stuff to this in the future!</p>

<p><em>Update</em>:
We aren&rsquo;t done yet; after I uploaded the app (<code>appcfg.py update</code>, which by the way prefers <code>--oauth2</code> but won&rsquo;t tell you about it) the html wasn&rsquo;t being served.
I added a <code>log.Fatal()</code> and sure enough the file wasn&rsquo;t being read any more.</p>

<p>This was also a good time to see error handling in place, the application logs showed</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>panic: os.Exit called
</span><span class='line'>runtime.panic go/src/pkg/runtime/panic.c:230
</span><span class='line'>os.Exit go/src/pkg/os/proc.go:42
</span><span class='line'>log.Fatal go/src/pkg/log/log.go:289
</span><span class='line'>agamsweb.indexHandler agamsweb/agamsweb.go:18
</span><span class='line'>net/http.HandlerFunc.ServeHTTP go/src/pkg/net/http/server.go:1150
</span><span class='line'>net/http.<span class="o">(</span>*ServeMux<span class="o">)</span>.ServeHTTP go/src/pkg/net/http/server.go:1417
</span><span class='line'>appengine_internal.executeRequestSafely go/src/pkg/appengine_internal/api_prod.go:248
</span><span class='line'>appengine_internal.<span class="o">(</span>*server<span class="o">)</span>.HandleRequest go/src/pkg/appengine_internal/api_prod.go:198
</span><span class='line'>reflect.Value.call go/src/pkg/reflect/value.go:474
</span><span class='line'>reflect.Value.Call go/src/pkg/reflect/value.go:345
</span><span class='line'>_ _.go:316
</span><span class='line'>runtime.goexit go/src/pkg/runtime/proc.c:280
</span></code></pre></td></tr></table></div></figure>


<p>While testing this I also ran into an appengine bug: it is possible to get the following error message, though it literally doesn&rsquo;t make much sense</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>E 2013-06-23 11:53:32.539
</span><span class='line'>Request failed because the app binary was missing. This can generally be fixed by redeploying your app.
</span><span class='line'>I 2013-06-23 11:53:32.539
</span><span class='line'>This request caused a new process to be started <span class="k">for </span>your application, and thus caused your application code to be loaded <span class="k">for </span>the first time.
</span><span class='line'>This request may thus take longer and use more CPU than a typical request <span class="k">for </span>your application.
</span></code></pre></td></tr></table></div></figure>


<p>(i..e how can the app binary be missing <em>after</em> the application was loaded? :) )</p>

<p>After much digging, realized that it isn&rsquo;t possible to read files specified by the <code>static</code> handler.</p>

<p>Hmm so I don&rsquo;t really need any go code to do anything meaningful right now, I&rsquo;ll leave &lsquo;hello world&rsquo; running :/</p>

      
      
    </div>
  </div>



    </article>
    
  
  <div class="pagination">
    
    <a class="prev" href="/blog/page/5/">&larr; Older</a>
    

    
    <a class="next" href="/blog/page/3/">Newer &rarr;</a>
    
  </div>
</div>


        </div>
      </div>
      <div class="row-fluid">
        <footer class="footer-page" role="contentinfo">
          <p>
  Copyright &copy; 2014 - Agam -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> - Theme by <a href="http://alexgaribay.com">Alex Garibay</a>
</p>


        </footer>
      </div>
  </div>
  

<script type="text/javascript">
      var disqus_shortname = 'agamamp';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
